<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2023å¹´å¹¿ä¸œé«˜èŒé«˜è€ƒè‹±è¯­ - æ™ºèƒ½è®­ç»ƒç³»ç»Ÿ (ä¿®å¤ç‰ˆ)</title>
    <style>
        /* --- 2023ç‰ˆè§†è§‰é£æ ¼ï¼šæ¸…æ–°ç»¿ä¸»é¢˜ --- */
        :root {
            --primary-color: #27ae60;       /* ä¸»è‰²è°ƒï¼šæ¸…æ–°ç»¿ */
            --secondary-color: #2c3e50;     /* æ·±ç° */
            --accent-color: #f39c12;        /* æ´»åŠ›æ©™ */
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --bg-color: #f4fcf6;
            --sidebar-width: 260px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
            line-height: 1.6;
        }

        /* --- ç§»åŠ¨ç«¯é€‚é…ç»„ä»¶ --- */
        .mobile-menu-btn {
            display: none;
            position: fixed; top: 15px; left: 15px; z-index: 200;
            background: var(--secondary-color); color: white;
            border: none; padding: 8px 12px; border-radius: 6px;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .mobile-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 150; backdrop-filter: blur(3px);
        }

        /* --- ç™»å½•å±‚ --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #27ae60, #82ccdd);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }

        .login-box {
            background: white; padding: 40px 30px; border-radius: 15px;
            width: 100%; max-width: 380px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .login-box h2 { margin-top: 0; color: var(--secondary-color); }
        .login-box input {
            width: 100%; padding: 12px; margin: 10px 0;
            border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 16px;
        }
        .login-box input:focus { border-color: var(--primary-color); outline: none; }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar {
            width: var(--sidebar-width); background-color: white;
            color: var(--secondary-color); display: flex; flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.05); z-index: 160;
            transition: transform 0.3s ease;
        }
        .user-info-display { padding: 30px 20px; background: #ecf0f1; border-bottom: 1px solid #ddd; }
        .sidebar-header-mobile { display: none; } 
        
        .menu-item {
            padding: 18px 25px; cursor: pointer; border-left: 5px solid transparent;
            font-weight: 500; color: #555; border-bottom: 1px solid #f9f9f9;
        }
        .menu-item:hover { background-color: #f4f6f7; }
        .menu-item.active { 
            background-color: #eaf8ee; border-left-color: var(--primary-color);
            color: var(--primary-color); font-weight: bold;
        }

        /* --- ä¸»å†…å®¹åŒº --- */
        .main-content {
            flex: 1; padding: 40px; overflow-y: auto;
            position: relative; scroll-behavior: smooth;
        }

        /* --- é¢˜ç›®å¡ç‰‡ --- */
        .question-card {
            background: white; padding: 30px; margin-bottom: 25px;
            border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .q-title { font-weight: 600; margin-bottom: 20px; font-size: 1.1em; color: #2c3e50; }

        /* --- é€‰é¡¹æŒ‰é’® --- */
        .options-group { display: grid; gap: 12px; }
        .option-btn {
            text-align: left; padding: 15px 20px; background: #f8f9fa;
            border: 1px solid #e9ecef; border-radius: 8px; cursor: pointer;
            font-size: 16px; color: #495057; transition: all 0.2s;
        }
        .option-btn:hover:not(:disabled) { background: #e2e6ea; }
        .option-btn.correct { background-color: #d4edda; border-color: var(--success-color); color: #155724; font-weight: bold; }
        .option-btn.wrong { background-color: #f8d7da; border-color: var(--error-color); color: #721c24; }

        /* --- åˆ†å±å¸ƒå±€ (é˜…è¯»/è¯­æ³•) --- */
        .split-layout { display: flex; gap: 30px; align-items: flex-start; height: calc(100vh - 120px); }
        .passage-panel {
            flex: 1; background: #fff; padding: 25px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow-y: auto; height: 100%;
            border-top: 4px solid var(--primary-color); line-height: 1.8; color: #444;
        }
        .questions-panel { flex: 1; overflow-y: auto; height: 100%; padding-right: 5px; }

        /* --- ç¿»è¯‘æ˜¾éšæ§åˆ¶ --- */
        .trans-toggle-btn {
            display: inline-block; margin-top: 8px; padding: 4px 10px;
            font-size: 0.85em; color: var(--primary-color); background: rgba(39, 174, 96, 0.1);
            border-radius: 4px; cursor: pointer;
        }
        .para-trans {
            display: none; margin-top: 10px; padding: 12px;
            background-color: #fcf8e3; border-left: 3px solid var(--accent-color);
            color: #666; font-size: 0.95em; border-radius: 0 4px 4px 0;
        }

        /* --- å¡«ç©ºè¾“å…¥æ¡† --- */
        .inline-input {
            border: none; border-bottom: 2px solid #bdc3c7; width: 100px;
            text-align: center; font-size: 1.1em; padding: 0 5px;
            background: #f4f6f9; color: #2c3e50; margin: 0 4px; border-radius: 4px 4px 0 0;
        }
        .inline-input:focus { outline: none; border-bottom-color: var(--primary-color); background: white; }
        .inline-input.correct { border-bottom-color: var(--success-color); color: var(--success-color); font-weight: bold; background: white; }
        .inline-input.wrong { border-bottom-color: var(--error-color); color: var(--error-color); background: #fff5f5; }

        /* --- è§£æåŒºåŸŸ --- */
        .analysis-box {
            margin-top: 20px; padding: 20px; background: #e8f8f0;
            border-radius: 8px; display: none; font-size: 0.95em; color: #34495e;
            border-left: 4px solid var(--primary-color);
        }
        .analysis-label { font-weight: bold; color: var(--primary-color); display: block; margin-bottom: 8px; }
        
        .check-btn {
            background: var(--secondary-color); color: white; border: none;
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;
        }

        /* --- æäº¤æŒ‰é’® --- */
        .submit-all-btn {
            position: fixed; bottom: 30px; right: 40px;
            background: var(--success-color); color: white; border: none;
            padding: 15px 35px; border-radius: 50px; font-size: 18px;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4); cursor: pointer; z-index: 100;
        }

        /* --- ç»“æœå¼¹çª— --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
            z-index: 2000; padding: 20px; box-sizing: border-box; backdrop-filter: blur(3px);
        }
        .result-card {
            background: white; padding: 40px; border-radius: 16px; text-align: center;
            width: 100%; max-width: 450px; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .score-num { font-size: 60px; color: var(--primary-color); font-weight: bold; display: block; margin: 15px 0; }
        .result-btns { display: flex; gap: 15px; justify-content: center; margin-top: 25px; }
        .res-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; color: white; }
        .btn-retry { background: var(--accent-color); }
        .btn-restart { background: var(--secondary-color); }
        
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 10px; font-size: 16px; box-sizing: border-box; }

        /* --- ç§»åŠ¨ç«¯å“åº”å¼ --- */
        @media (max-width: 768px) {
            body { font-size: 15px; } 
            .mobile-menu-btn { display: block; }
            .sidebar { position: fixed; top: 0; left: -100%; height: 100%; width: 80%; max-width: 300px; }
            .sidebar.active-mobile { left: 0; }
            .sidebar-header-mobile { display: flex; justify-content: flex-end; padding: 10px; }
            .close-menu-btn { background: none; border: none; color: #333; font-size: 24px; }
            .main-content { padding: 60px 15px 90px 15px; width: 100%; }
            .split-layout { flex-direction: column; height: auto; gap: 20px; }
            .passage-panel { width: 100%; height: auto; max-height: 40vh; border-top: none; border-left: 4px solid var(--primary-color); padding: 15px; box-sizing: border-box; }
            .questions-panel { width: 100%; height: auto; overflow: visible; padding-right: 0; }
            .inline-input { width: 80px; }
            .submit-all-btn { right: 50%; transform: translateX(50%); bottom: 20px; width: 85%; text-align: center; }
        }
    </style>
</head>
<body>

<div class="mobile-overlay" id="mobile-overlay" onclick="toggleSidebar()"></div>
<button class="mobile-menu-btn" onclick="toggleSidebar()">â˜° é¢˜ç›®ç›®å½•</button>

<div id="login-overlay">
    <div class="login-box">
        <h2>ğŸ“š 2023 é«˜èŒé«˜è€ƒè‹±è¯­</h2>
        <p style="color:#7f8c8d; margin-bottom:20px;">å…¨çœŸæ¨¡æ‹Ÿæ™ºèƒ½è®­ç»ƒ</p>
        <input type="text" id="u-class" placeholder="ç­çº§">
        <input type="text" id="u-id" placeholder="å­¦å·">
        <input type="text" id="u-name" placeholder="å§“å">
        <button onclick="login()" class="check-btn" style="width:100%; margin-top:20px; background:var(--primary-color); font-size:16px; padding:12px;">å¼€å§‹ç­”é¢˜</button>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header-mobile">
        <button class="close-menu-btn" onclick="toggleSidebar()">Ã—</button>
    </div>
    <div class="user-info-display">
        <h3 id="disp-name" style="margin:0">è€ƒç”Ÿ</h3>
        <p id="disp-id" style="margin:5px 0 0; font-size:0.9em; color:#666">--</p>
    </div>
    <div id="menu-container"></div>
</div>

<div class="main-content" id="main-area">
    <div id="content-container"></div>
</div>

<button class="submit-all-btn" onclick="submitExam()">æäº¤è¯•å·</button>

<div class="modal-overlay" id="result-modal">
    <div class="result-card">
        <h2>è€ƒè¯•ç»“æŸ</h2>
        <p>æ‚¨çš„å¾—åˆ†ä¸º</p>
        <span class="score-num" id="final-score">0</span>
        <div class="result-btns">
            <button class="res-btn btn-retry" onclick="retryWrongMode()">é”™é¢˜é‡ç»ƒ</button>
            <button class="res-btn btn-restart" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
        </div>
    </div>
</div>

<script>
    // ===============================================
    // 2023å¹´çœŸé¢˜æ•°æ® (å·²ä¿®å¤è¯­æ³•é”™è¯¯)
    // ===============================================
    const examData = [
        {
            id: 'part1',
            title: "I. è¡¥å…¨å¯¹è¯",
            type: 'choice',
            desc: "é˜…è¯»ä¸‹åˆ—ç®€çŸ­å¯¹è¯ï¼Œä»Aã€Bã€Cã€Dä¸­é€‰å‡ºæœ€ä½³ç­”æ¡ˆã€‚",
            questions: [
                { id: 1, q: "M: Would you like me to open the window?<br>W: ______", options: ["A. It doesn't matter", "B. I don't know", "C. Never mind", "D. Yes, please"], ans: "D", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€ç¿»è¯‘ã€‘ç”·ï¼šä½ æƒ³è®©æˆ‘æ‰“å¼€çª—æˆ·å—ï¼Ÿå¥³ï¼šæ˜¯çš„ï¼Œè¯·ï¼ˆæ‰“å¼€ï¼‰ã€‚<br>ã€è§£æã€‘è€ƒæŸ¥æƒ…æ™¯äº¤é™…ï¼ŒDé€‰é¡¹ç¬¦åˆæ¥å—æè®®çš„ç¤¼è²Œå›åº”ã€‚" },
                { id: 2, q: "M: ______?<br>W: I'd like to have a cup of coffee.", options: ["A. What do you mean", "B. How are you", "C. May I help you", "D. Are you with me"], ans: "C", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€ç¿»è¯‘ã€‘ç”·ï¼šè¯·é—®æ‚¨æƒ³è¦ç‚¹ä»€ä¹ˆï¼Ÿï¼ˆæˆ–ï¼šéœ€è¦æˆ‘å¸®å¿™å—ï¼Ÿï¼‰å¥³ï¼šæˆ‘æƒ³å–æ¯å’–å•¡ã€‚<br>ã€è§£æã€‘è€ƒæŸ¥é¤å…æˆ–æœåŠ¡åœºæ‰€çš„å¸¸ç”¨è¯­ï¼ŒCé€‰é¡¹æ„ä¸ºâ€œæˆ‘èƒ½å¸®æ‚¨å—â€ã€‚" },
                { id: 3, q: "W: Thank you very much for coming to meet me, Mr. Smith.<br>M: ______", options: ["A. I hope so", "B. I see", "C. Have a nice day", "D. My pleasure"], ans: "D", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€ç¿»è¯‘ã€‘å¥³ï¼šå²å¯†æ–¯å…ˆç”Ÿï¼Œéå¸¸æ„Ÿè°¢ä½ è¿‡æ¥æ¥æˆ‘ã€‚ç”·ï¼šè¿™æ˜¯æˆ‘çš„è£å¹¸ã€‚<br>ã€è§£æã€‘è€ƒæŸ¥è‡´è°¢çš„å›åº”ï¼ŒMy pleasureæ˜¯å›åº”æ„Ÿè°¢çš„å¸¸ç”¨ä½“é¢è¯´æ³•ã€‚" },
                { id: 4, q: "M: Excuse me. Could you tell me how to get to Garden Hotel?<br>W: Garden Hotel? ______ I really don't know.", options: ["A. Forget it", "B. I'm sorry", "C. Go ahead", "D. All right"], ans: "B", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€ç¿»è¯‘ã€‘ç”·ï¼šæ‰“æ‰°ä¸€ä¸‹ã€‚ä½ èƒ½å‘Šè¯‰æˆ‘æ€ä¹ˆå»èŠ±å›­é…’åº—å—ï¼Ÿå¥³ï¼šèŠ±å›­é…’åº—ï¼Ÿå¯¹ä¸èµ·ï¼Œæˆ‘çœŸçš„ä¸çŸ¥é“ã€‚<br>ã€è§£æã€‘å½“æ— æ³•æä¾›å¯¹æ–¹è¯·æ±‚çš„å¸®åŠ©ï¼ˆæŒ‡è·¯ï¼‰æ—¶ï¼Œåº”å…ˆè¡¨ç¤ºæŠ±æ­‰ã€‚" },
                { id: 5, q: "M: Hello! This is Tom speaking. May I speak to Jane, please?<br>W: ______", options: ["A. Hold on, please", "B. You're welcome", "C. Nice to meet you", "D. She's my sister"], ans: "A", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€ç¿»è¯‘ã€‘ç”·ï¼šä½ å¥½ï¼æˆ‘æ˜¯æ±¤å§†ã€‚è¯·æ‰¾ä¸€ä¸‹ç®€å¥½å—ï¼Ÿå¥³ï¼šè¯·ç¨ç­‰ã€‚<br>ã€è§£æã€‘è€ƒæŸ¥ç”µè¯ç”¨è¯­ï¼ŒHold onæ„ä¸ºâ€œåˆ«æŒ‚æ–­ï¼Œç¨ç­‰â€ã€‚" }
            ]
        },
        {
            id: 'part2',
            title: "II. è¯æ±‡",
            type: 'choice',
            desc: "é€‰å‡ºå¥ä¸­ç”»çº¿å•è¯æˆ–è¯ç»„çš„æ„ä¹‰ã€‚",
            questions: [
                { id: 6, q: "Please <u>remind</u> me to take my medicine tomorrow.", options: ["A. å¼ºè¿«", "B. å»ºè®®", "C. å©å’", "D. æé†’"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>remindï¼šæé†’ã€‚å¥æ„ï¼šè¯·æé†’æˆ‘æ˜å¤©åƒè¯ã€‚" },
                { id: 7, q: "There are many <u>poisonous</u> snakes in the area.", options: ["A. å¯æ€•çš„", "B. æœ‰æ¯’çš„", "C. å‡¶çŒ›çš„", "D. ç¨€æœ‰çš„"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>poisonousï¼šæœ‰æ¯’çš„ã€‚å¥æ„ï¼šè¿™ä¸ªåœ°åŒºæœ‰å¾ˆå¤šæ¯’è›‡ã€‚" },
                { id: 8, q: "The song was <u>specially</u> written for her birthday.", options: ["A. å•ç‹¬åœ°", "B. éšæ„åœ°", "C. ä¸“é—¨åœ°", "D. é¡ºä¾¿åœ°"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>speciallyï¼šä¸“é—¨åœ°ã€‚å¥æ„ï¼šè¿™é¦–æ­Œæ˜¯ä¸“é—¨ä¸ºå¥¹ç”Ÿæ—¥å†™çš„ã€‚" },
                { id: 9, q: "They have been <u>out of work</u> for years since their factory was closed down.", options: ["A. å¤±ä¸š", "B. ä¼‘å‡", "C. å¿™ç¢Œ", "D. æ±‚èŒ"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>out of workï¼šå¤±ä¸šã€‚å¥æ„ï¼šè‡ªä»å·¥å‚å€’é—­ä»¥æ¥ï¼Œä»–ä»¬å·²ç»å¤±ä¸šå¤šå¹´äº†ã€‚" },
                { id: 10, q: "This business plan looks very <u>professional</u>.", options: ["A. ä¸“ä¸šçš„", "B. è‘—åçš„", "C. ä¸€æµçš„", "D. å›½é™…çš„"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>professionalï¼šä¸“ä¸šçš„ã€‚å¥æ„ï¼šè¿™ä»½å•†ä¸šè®¡åˆ’ä¹¦çœ‹èµ·æ¥å¾ˆä¸“ä¸šã€‚" },
                { id: 11, q: "He <u>applied</u> to work in another school.", options: ["A. æ¸´æœ›", "B. æ³æ±‚", "C. å‘¼å", "D. ç”³è¯·"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>applyï¼šç”³è¯·ã€‚å¥æ„ï¼šä»–ç”³è¯·åˆ°å¦ä¸€æ‰€å­¦æ ¡å·¥ä½œã€‚" },
                { id: 12, q: "The rubbish must be <u>removed</u> to keep the classroom tidy.", options: ["A. ç„šçƒ§", "B. æ©åŸ‹", "C. æ¸…é™¤", "D. åˆ†ç±»"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>removeï¼šæ¸…é™¤ï¼Œç§»èµ°ã€‚å¥æ„ï¼šåƒåœ¾å¿…é¡»æ¸…é™¤ä»¥ä¿æŒæ•™å®¤æ•´æ´ã€‚" },
                { id: 13, q: "They had an accident on the road and didn't <u>check in</u> at their hotel until midnight.", options: ["A. è®¤é¢†è¡Œæ", "B. ç™»è®°å…¥ä½", "C. æŠµè¾¾", "D. é€šçŸ¥"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>check inï¼šç™»è®°å…¥ä½ã€‚å¥æ„ï¼šä»–ä»¬åœ¨è·¯ä¸Šå‡ºäº†äº‹æ•…ï¼Œç›´åˆ°åŠå¤œæ‰åœ¨æ—…é¦†ç™»è®°å…¥ä½ã€‚" },
                { id: 14, q: "Truth is what we have been <u>seeking</u> all our life.", options: ["A. è¿½æ±‚", "B. è®¤åŒ", "C. æ£€éªŒ", "D. ä¼ æ’­"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>seekï¼šå¯»æ‰¾ï¼Œè¿½æ±‚ã€‚å¥æ„ï¼šçœŸç†æ˜¯æˆ‘ä»¬ä¸€ç”Ÿæ‰€è¿½æ±‚çš„ä¸œè¥¿ã€‚" },
                { id: 15, q: "The failure was an unexpected <u>blow</u> to him.", options: ["A. æœºä¼š", "B. æ‰“å‡»", "C. æ•™è®­", "D. å˜æ•…"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>blowï¼šæ‰“å‡»ã€‚å¥æ„ï¼šè¿™æ¬¡å¤±è´¥å¯¹ä»–æ˜¯ä¸€ä¸ªæ„å¤–çš„æ‰“å‡»ã€‚" }
            ]
        },
        {
            id: 'part3',
            title: "III. å®Œå½¢å¡«ç©º",
            type: 'split_choice',
            desc: "é˜…è¯»çŸ­æ–‡ï¼Œä»æ¯é¢˜æ‰€ç»™çš„å››ä¸ªé€‰é¡¹ä¸­é€‰å‡ºæœ€ä½³é€‰é¡¹ã€‚(æ•…äº‹èƒŒæ™¯ï¼šé‡ç‰›ä¸è€é¼ çš„å†³æ–—)",
            paragraphs: [
                { en: "When Mouse was out gathering food for the winter, Buffalo came down to eat the grass. The little mouse did not [16] this, for he knew that Buffalo would eat all the long [17] and there would be no place for him to [18].", cn: "ã€è¯‘æ–‡ã€‘å½“è€é¼ æ­£å¤–å‡ºä¸ºå†¬å¤©æ”¶é›†é£Ÿç‰©æ—¶ï¼Œé‡ç‰›ä¸‹æ¥åƒè‰ã€‚å°è€é¼ ä¸å–œæ¬¢[16](like)è¿™æ ·ï¼Œå› ä¸ºä»–çŸ¥é“é‡ç‰›ä¼šåƒæ‰æ‰€æœ‰çš„é•¿[17]è‰(grasses)ï¼Œè®©ä»–æ— å¤„[18]èº²è—(hide)ã€‚" },
                { en: "He made up his mind to [19] Buffalo. \"Hi, Buffalo, I challenge you to a fight!\" he cried in an angry [20]. Buffalo looked at him and replied, \"You'd better [21], little one, or I shall step on you and there will be nothing left!\"", cn: "ã€è¯‘æ–‡ã€‘ä»–å†³å¿ƒä¸é‡ç‰›[19]å†³æ–—(fight)ã€‚â€œå˜¿ï¼Œé‡ç‰›ï¼Œæˆ‘è¦å‘ä½ æŒ‘æˆ˜ï¼â€ä»–ç”¨æ„¤æ€’çš„[20]å£°éŸ³(voice)å–Šé“ã€‚é‡ç‰›çœ‹ç€ä»–å›ç­”è¯´ï¼šâ€œä½ æœ€å¥½[21]é—­å˜´(shut up)ï¼Œå°å®¶ä¼™ï¼Œå¦åˆ™æˆ‘ä¼šä¸€è„šè¸©åœ¨ä½ èº«ä¸Šï¼Œè®©ä½ ç°é£çƒŸç­ï¼â€" },
                { en: "But Mouse [22] repeated the challenge. Buffalo rushed toward Mouse and stepped on him [23]. Then he looked down. To his [24], he could not find Mouse anywhere.", cn: "ã€è¯‘æ–‡ã€‘ä½†è€é¼ [22]æ„¤æ€’åœ°(angrily)é‡å¤äº†æŒ‘æˆ˜ã€‚é‡ç‰›å†²å‘è€é¼ ï¼Œ[23]é‡é‡åœ°(heavily)è¸©äº†ä¸‹å»ã€‚ç„¶åä»–å¾€ä¸‹çœ‹ï¼Œä»¤ä»–[24]æƒŠè®¶(surprise)çš„æ˜¯ï¼Œåˆ°å¤„éƒ½æ‰¾ä¸åˆ°è€é¼ ã€‚" },
                { en: "Just then he felt a pain inside his right [25]. He shook his head as hard as he could, and ran here and there wildly. But the [26] went deeper and deeper until at last he fell to the ground and lay [27].", cn: "ã€è¯‘æ–‡ã€‘å°±åœ¨é‚£æ—¶ï¼Œä»–æ„Ÿåˆ°å³[25]è€³(ear)å†…ä¸€é˜µå‰§ç—›ã€‚ä»–æ‹¼å‘½æ‘‡å¤´ï¼Œå››å¤„ç‹‚å¥”ã€‚ä½†[26]ç–¼ç—›(pain)è¶Šæ¥è¶Šæ·±ï¼Œæœ€åä»–å€’åœ¨åœ°ä¸Šï¼Œ[27]ä¸€åŠ¨ä¸åŠ¨(still)ã€‚" },
                { en: "Mouse came out of his ear, and stood proudly upon his body. \"Eho!\" he shouted loudly, \"I have [28] the greatest animal of all!\" In another part of the grassland, the hungry Red Fox [29] the shout. He ran as fast as he could in the direction of the shout. Soon he came upon the huge body of Buffalo with the little mouse still [30] upon it. Fox jumped upon Mouse, who gave one last cry and disappeared.", cn: "ã€è¯‘æ–‡ã€‘è€é¼ ä»ä»–è€³æœµé‡Œé’»å‡ºæ¥ï¼Œéª„å‚²åœ°ç«™åœ¨ä»–çš„å°¸ä½“ä¸Šã€‚â€œå“¦å—¬ï¼â€ä»–å¤§å£°å–Šé“ï¼Œâ€œæˆ‘[28]æ‰“è´¥(defeat)äº†æ‰€æœ‰åŠ¨ç‰©ä¸­æœ€ä¼Ÿå¤§çš„ä¸€ä¸ªï¼â€åœ¨è‰åŸçš„å¦ä¸€è¾¹ï¼Œé¥¥é¥¿çš„çº¢ç‹ç‹¸[29]å¬åˆ°(heard)äº†å–Šå£°ã€‚ä»–æœç€å–Šå£°çš„æ–¹å‘æ‹¼å‘½è·‘å»ã€‚å¾ˆå¿«ï¼Œä»–å‘ç°äº†é‡ç‰›å·¨å¤§çš„å°¸ä½“ï¼Œå°è€é¼ è¿˜[30]ç«™(standing)åœ¨ä¸Šé¢ã€‚ç‹ç‹¸æ‰‘å‘è€é¼ ï¼Œè€é¼ å‘å‡ºæœ€åä¸€å£°å“€é¸£åæ¶ˆå¤±äº†ã€‚" }
            ],
            questions: [
                { id: 16, options: ["A. see", "B. hear", "C. feel", "D. like"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>è€é¼ ä¸å–œæ¬¢é‡ç‰›æ¥åƒè‰ã€‚" },
                { id: 17, options: ["A. trees", "B. flowers", "C. grasses", "D. roads"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>é‡ç‰›ä¼šåƒå…‰é•¿è‰ã€‚" },
                { id: 18, options: ["A. hide", "B. play", "C. sleep", "D. eat"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>è‰æ²¡äº†ï¼Œè€é¼ å°±æ²¡åœ°æ–¹èº²è—ã€‚" },
                { id: 19, options: ["A. help", "B. kill", "C. fight", "D. eat"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>æ ¹æ®åæ–‡ï¼Œè€é¼ å†³å®šå‘é‡ç‰›æŒ‘æˆ˜(fight)ã€‚" },
                { id: 20, options: ["A. way", "B. voice", "C. face", "D. mood"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>è€é¼ ç”¨æ„¤æ€’çš„å£°éŸ³å¤§å–Šã€‚" },
                { id: 21, options: ["A. shut up", "B. stand up", "C. wake up", "D. hurry up"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>é‡ç‰›è®©è€é¼ é—­å˜´ã€‚" },
                { id: 22, options: ["A. happily", "B. sadly", "C. slowly", "D. angrily"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>è€é¼ ç”Ÿæ°”åœ°é‡å¤æŒ‘æˆ˜ã€‚" },
                { id: 23, options: ["A. lightly", "B. heavily", "C. quickly", "D. slowly"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>é‡ç‰›é‡é‡åœ°è¸©åœ¨è€é¼ èº«ä¸Šã€‚" },
                { id: 24, options: ["A. joy", "B. sadness", "C. surprise", "D. anger"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>ä»¤é‡ç‰›æƒŠè®¶çš„æ˜¯æ‰¾ä¸åˆ°è€é¼ ã€‚" },
                { id: 25, options: ["A. eye", "B. ear", "C. nose", "D. mouth"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>è€é¼ é’»è¿›äº†é‡ç‰›çš„è€³æœµã€‚" },
                { id: 26, options: ["A. mouse", "B. buffalo", "C. noise", "D. pain"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>é‡ç‰›è€³æœµé‡Œçš„ç–¼ç—›è¶Šæ¥è¶Šæ·±ã€‚" },
                { id: 27, options: ["A. still", "B. awake", "C. asleep", "D. alive"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>é‡ç‰›å€’åœ¨åœ°ä¸Šçº¹ä¸ä¸åŠ¨(still)ã€‚" },
                { id: 28, options: ["A. killed", "B. hit", "C. defeat", "D. eaten"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>è€é¼ å®£ç§°æˆ˜èƒœ(defeat)äº†æœ€å¼ºå¤§çš„åŠ¨ç‰©ã€‚" },
                { id: 29, options: ["A. heard", "B. saw", "C. smelt", "D. felt"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>çº¢ç‹ç‹¸å¬åˆ°äº†å«å–Šå£°ã€‚" },
                { id: 30, options: ["A. sitting", "B. lying", "C. sleeping", "D. standing"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>è€é¼ è¿˜ç«™åœ¨é‡ç‰›å°¸ä½“ä¸Šã€‚" }
            ]
        },
        {
            id: 'part5',
            title: "V. è¯­æ³•å¡«ç©º",
            type: 'split_input',
            desc: "é˜…è¯»ä¸‹é¢çŸ­æ–‡ï¼Œåœ¨ç©ºæ ¼å¤„å¡«å…¥é€‚å½“çš„è¯ã€‚(æ•…äº‹èƒŒæ™¯ï¼šCaraå‚åŠ èµ›è·‘)",
            paragraphs: [
                { en: "Cara was nervous before the race. For several weeks, she had been training every day to prepare for it. [46] ______ (final) the race day came. [47] ______ she arrived, her coach was already on the track.", cn: "ã€è¯‘æ–‡ã€‘å¡æ‹‰åœ¨èµ›å‰å¾ˆç´§å¼ ã€‚ä¸ºäº†å‡†å¤‡æ¯”èµ›ï¼Œå¥¹å·²ç»è¿ç»­å‡ å‘¨æ¯å¤©è®­ç»ƒã€‚[46]æœ€ç»ˆ(Finally)ï¼Œæ¯”èµ›é‚£å¤©åˆ°äº†ã€‚[47]å½“(When)å¥¹åˆ°è¾¾æ—¶ï¼Œå¥¹çš„æ•™ç»ƒå·²ç»ç«™åœ¨è·‘é“ä¸Šäº†ã€‚" },
                { en: "Cara started her warm-up exercise under the guidance of the coach. This was helpful to keep [48] ______ (she) from getting hurt. Cara's friends got there [49] ______ (early) than her. They let her know that they were there [50] ______ (cheer) for her.", cn: "ã€è¯‘æ–‡ã€‘å¡æ‹‰åœ¨æ•™ç»ƒçš„æŒ‡å¯¼ä¸‹å¼€å§‹åšçƒ­èº«è¿åŠ¨ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢[48]å¥¹(her)å—ä¼¤ã€‚å¡æ‹‰çš„æœ‹å‹ä»¬æ¯”å¥¹åˆ°å¾—[49]æ—©(earlier)ã€‚ä»–ä»¬è®©å¥¹çŸ¥é“ä»–ä»¬æ˜¯æ¥ä¸ºå¥¹[50]åŠ æ²¹(to cheer)çš„ã€‚" },
                { en: "They all wished her good luck. It was time for the race. All the runners [51] ______ (call) to line up on the tracks. [52] ______ (hear) the signal gun, Cara jump-started from the ground. She began to run as hard as she could.", cn: "ã€è¯‘æ–‡ã€‘ä»–ä»¬éƒ½ç¥å¥¹å¥½è¿ã€‚æ¯”èµ›æ—¶é—´åˆ°äº†ï¼Œæ‰€æœ‰çš„è¿åŠ¨å‘˜éƒ½[51]è¢«å«(were called)åˆ°è·‘é“ä¸Šæ’é˜Ÿã€‚[52]å¬åˆ°(Hearing)å‘ä»¤æªå£°ï¼Œå¡æ‹‰è¿…é€Ÿèµ·è·‘ã€‚å¥¹å¼€å§‹æ‹¼å‘½å¥”è·‘ã€‚" },
                { en: "Running past the stands, she heard the voices of her friends cheering her name. Cara kept her energy and continued to keep a good speed. When she rounded the track [53] ______ the last time, she and another runner were neck and neck for [54] ______ finish line.", cn: "ã€è¯‘æ–‡ã€‘è·‘è¿‡çœ‹å°æ—¶ï¼Œå¥¹å¬åˆ°æœ‹å‹ä»¬æ¬¢å‘¼å¥¹çš„åå­—ã€‚å¡æ‹‰ä¿æŒç€ä½“åŠ›å¹¶ç»§ç»­ä¿æŒè‰¯å¥½çš„é€Ÿåº¦ã€‚å½“å¥¹æœ€å[53]ä¸€æ¬¡(for)ç»•è¿‡è·‘é“æ—¶ï¼Œå¥¹å’Œå¦ä¸€åé€‰æ‰‹ä¸åˆ†ä¸Šä¸‹åœ°å†²å‘[54]ç»ˆç‚¹çº¿(the)ã€‚" },
                { en: "As the end approached, Cara put all her effort into those last few [55] ______ (foot). She won the race narrowly. Cara was so happy.", cn: "ã€è¯‘æ–‡ã€‘éšç€ç»ˆç‚¹çš„ä¸´è¿‘ï¼Œå¡æ‹‰åœ¨æœ€åå‡ [55]è‹±å°º(feet)ä½¿å‡ºäº†å…¨èº«åŠ›æ°”ã€‚å¥¹ä»¥å¾®å¼±ä¼˜åŠ¿èµ¢å¾—äº†æ¯”èµ›ï¼Œå¡æ‹‰éå¸¸å¼€å¿ƒã€‚" }
            ],
            questions: [
                { id: 46, ans: "Finally", exp: "<span class='analysis-label'>è§£æ</span>å‰¯è¯ä¿®é¥°å…¨å¥ï¼šæœ€ç»ˆï¼Œæ¯”èµ›æ—¥åˆ°äº†ã€‚" },
                { id: 47, ans: "When", exp: "<span class='analysis-label'>è§£æ</span>è¿è¯ï¼šå½“å¥¹åˆ°è¾¾æ—¶ï¼Œæ•™ç»ƒå·²åœ¨è·‘é“ä¸Šã€‚" },
                { id: 48, ans: "her", exp: "<span class='analysis-label'>è§£æ</span>å®¾æ ¼ä»£è¯ï¼škeep her from getting hurt é˜²æ­¢å¥¹å—ä¼¤ã€‚" },
                { id: 49, ans: "earlier", exp: "<span class='analysis-label'>è§£æ</span>æ¯”è¾ƒçº§ï¼šthanæ˜¯æ ‡å¿—ï¼Œæœ‹å‹æ¯”å¥¹åˆ°å¾—æ—©ã€‚" },
                { id: 50, ans: "to cheer", exp: "<span class='analysis-label'>è§£æ</span>ä¸å®šå¼è¡¨ç›®çš„ï¼šä»–ä»¬åœ¨é‚£å„¿æ˜¯ä¸ºäº†å»ä¸ºå¥¹åŠ æ²¹ã€‚" },
                { id: 51, ans: "were called", exp: "<span class='analysis-label'>è§£æ</span>è¢«åŠ¨è¯­æ€ï¼šæ‰€æœ‰çš„è·‘æ­¥è€…éƒ½è¢«å«å»æ’é˜Ÿã€‚" },
                { id: 52, ans: "Hearing", exp: "<span class='analysis-label'>è§£æ</span>ç°åœ¨åˆ†è¯ä½œçŠ¶è¯­ï¼šå¬åˆ°å‘ä»¤æªå“ï¼Œå¡æ‹‰è·³èµ·å‡ºå‘ã€‚" },
                { id: 53, ans: "for", exp: "<span class='analysis-label'>è§£æ</span>å›ºå®šæ­é…ï¼šfor the last time æœ€åä¸€æ¬¡ã€‚" },
                { id: 54, ans: "the", exp: "<span class='analysis-label'>è§£æ</span>å®šå† è¯ï¼šç‰¹æŒ‡ç»ˆç‚¹çº¿ã€‚" },
                { id: 55, ans: "feet", exp: "<span class='analysis-label'>è§£æ</span>å¤æ•°ï¼šfewåé¢æ¥åè¯å¤æ•°ï¼ˆè‹±å°ºï¼‰ã€‚" }
            ]
        },
        {
            id: 'part6',
            title: "VI. å®Œæˆå¥å­",
            type: 'input_sentence',
            desc: "æ ¹æ®æ‰€ç»™æ±‰è¯­æç¤ºï¼Œå®Œæˆè‹±è¯­å¥å­ã€‚<b>å¡«å†™åç‚¹å‡»å³ä¾§ã€ç¡®è®¤ã€‘æŒ‰é’®ã€‚</b>",
            questions: [
                { id: 56, q: "56. The film ______ (æˆ‘æ˜¨å¤©çœ‹çš„ç”µå½±) is very interesting.", ans: "that I watched yesterday", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€å¥æ„ã€‘æˆ‘æ˜¨å¤©çœ‹çš„ç”µå½±éå¸¸æœ‰è¶£ã€‚<br>ã€è§£æã€‘è€ƒæŸ¥å®šè¯­ä»å¥ï¼Œä»å¥æ”¾åœ¨å…ˆè¡Œè¯filmä¹‹åã€‚" },
                { id: 57, q: "57. Believe it or not, ______ (æœ¬å‘¨æˆ‘å°†æ­¥è¡Œä¸Šç­).", ans: "I will go to work on foot this week", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€å¥æ„ã€‘ä½ å¯èƒ½ä¸ç›¸ä¿¡ï¼Œæœ¬å‘¨æˆ‘å°†æ­¥è¡Œä¸Šç­ã€‚<br>ã€è§£æã€‘è€ƒæŸ¥å®¾è¯­ä»å¥åŠå›ºå®šçŸ­è¯­on footã€‚" },
                { id: 58, q: "58. What they are doing ______ (è·Ÿæˆ‘æ²¡æœ‰å¤šå¤§å…³ç³»).", ans: "is none of my business", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€å¥æ„ã€‘ä»–ä»¬æ­£åœ¨åšçš„äº‹æƒ…è·Ÿæˆ‘æ²¡æœ‰å¤šå¤§å…³ç³»ã€‚<br>ã€è§£æã€‘è€ƒæŸ¥çŸ­è¯­has nothing to do with me æˆ– is none of my businessã€‚" },
                { id: 59, q: "59. She is going to spend her summer holiday in Qingdao, ______ (é‚£å„¿å¥¹æœ‰ä¸€äº›äº²æˆš).", ans: "where she has some relatives", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€å¥æ„ã€‘å¥¹æ‰“ç®—å»é’å²›åº¦æš‘å‡ï¼Œåœ¨é‚£å„¿å¥¹æœ‰ä¸€äº›äº²æˆšã€‚<br>ã€è§£æã€‘è€ƒæŸ¥éé™åˆ¶æ€§å®šè¯­ä»å¥ï¼ŒwhereæŒ‡ä»£Qingdaoã€‚" },
                { id: 60, q: "60. Li Ming is ______ (å’Œæˆ‘ä¸€æ ·é«˜).", ans: "as tall as me", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€å¥æ„ã€‘ææ˜å’Œæˆ‘ä¸€æ ·é«˜ã€‚<br>ã€è§£æã€‘è€ƒæŸ¥åŒçº§æ¯”è¾ƒç»“æ„as...as...ã€‚" }
            ]
        },
        {
            id: 'part7',
            title: "VII. åº”ç”¨å†™ä½œ",
            type: 'writing',
            desc: "è¯·åœ¨ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­è¾“å…¥ä½œæ–‡ã€‚<b>ç‚¹å‡»è¾“å…¥æ¡†æŸ¥çœ‹å‚è€ƒèŒƒæ–‡ã€‚</b>",
            questions: [
                { id: 61, q: "61. ä½ æ˜¯æåï¼Œä¸‹å‘¨æ—¥æ˜¯ä½ çš„ç”Ÿæ—¥ï¼Œè¯·å†™ä¿¡é‚€è¯·å¤–æ•™Robertå‚åŠ èšä¼šã€‚å†…å®¹åŒ…æ‹¬ï¼š1. èšä¼šæ—¶é—´ï¼ˆä¸‹å‘¨æ—¥æ™š6ç‚¹åˆ°11ç‚¹ï¼‰ï¼›2. åœ°ç‚¹ï¼ˆæåå®¶ï¼‰ï¼›3. å‚åŠ äººå‘˜ï¼ˆå…¨ç­å¸ˆç”Ÿï¼‰ã€‚ï¼ˆçº¦40è¯ï¼‰", ans: "Dear Robert,\nHow is it going? I'm Li Hua. I'm writing to invite you to my birthday party. It will be held in my house from 6:00 p.m. to 11:00 p.m. next Sunday. All the teachers and students in our class will be invited. Please let me know if you can accept my invitation as soon as possible. I'm sure you will have a good time there.\nYours,\nLi Hua", exp: "<span class='analysis-label'>å‚è€ƒèŒƒæ–‡ç¿»è¯‘</span><br>äº²çˆ±çš„ç½—ä¼¯ç‰¹ï¼š<br>è¿‘æ¥å¥½å—ï¼Ÿæˆ‘æ˜¯æåã€‚æˆ‘å†™è¿™å°ä¿¡æ˜¯æƒ³é‚€è¯·ä½ å‚åŠ æˆ‘çš„ç”Ÿæ—¥èšä¼šã€‚èšä¼šå°†äºä¸‹å‘¨æ—¥æ™š6ç‚¹åˆ°11ç‚¹åœ¨æˆ‘å®¶ä¸¾è¡Œã€‚æˆ‘ä»¬ç­æ‰€æœ‰çš„è€å¸ˆå’ŒåŒå­¦éƒ½ä¼šè¢«é‚€è¯·ã€‚å¦‚æœä½ èƒ½æ¥å—æˆ‘çš„é‚€è¯·ï¼Œè¯·å°½å¿«å‘ŠçŸ¥æˆ‘ã€‚æˆ‘ç›¸ä¿¡ä½ ä¼šåœ¨é‚£é‡Œåº¦è¿‡æ„‰å¿«çš„æ—¶å…‰ã€‚<br>ä½ çš„ï¼Œæå" }
            ]
        }
    ];

    // ===============================================
    // é€»è¾‘æ§åˆ¶ (æ ¸å¿ƒ)
    // ===============================================
    let userResponses = {}; 
    let isRetryMode = false;
    let correctIds = new Set(); 

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');
        if (sidebar.classList.contains('active-mobile')) {
            sidebar.classList.remove('active-mobile');
            overlay.style.display = 'none';
        } else {
            sidebar.classList.add('active-mobile');
            overlay.style.display = 'block';
        }
    }

    function login() {
        const cls = document.getElementById('u-class').value;
        const name = document.getElementById('u-name').value;
        if (!cls || !name) return alert("è¯·è¾“å…¥ç­çº§å’Œå§“å");
        
        document.getElementById('disp-name').innerText = name;
        document.getElementById('disp-id').innerText = cls + "ç­";
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('sidebar').style.display = 'flex';
        document.getElementById('main-area').style.display = 'block';
        
        initMenu();
        showSection(0);
    }

    function initMenu() {
        const container = document.getElementById('menu-container');
        container.innerHTML = '';
        examData.forEach((part, index) => {
            const item = document.createElement('div');
            item.className = 'menu-item';
            item.innerHTML = part.title;
            item.onclick = () => {
                showSection(index);
                if(window.innerWidth <= 768) toggleSidebar();
            };
            container.appendChild(item);
        });
    }

    function showSection(index) {
        const container = document.getElementById('content-container');
        container.innerHTML = ''; 
        document.querySelectorAll('.menu-item').forEach((el, i) => {
            el.classList.toggle('active', i === index);
        });
        const data = examData[index];
        const title = document.createElement('h2');
        title.innerHTML = data.title + (isRetryMode ? " <span style='color:red;font-size:0.6em'>(é”™é¢˜é‡ç»ƒ)</span>" : "");
        container.appendChild(title);
        if(data.desc) {
            const desc = document.createElement('p');
            desc.innerHTML = data.desc; desc.style.color = '#666'; container.appendChild(desc);
        }
        if (data.type === 'choice') renderChoice(data, container);
        else if (data.type === 'split_choice') renderSplitChoice(data, container);
        else if (data.type === 'split_input') renderSplitInput(data, container);
        else if (data.type === 'input_sentence') renderInputSentence(data, container);
        else if (data.type === 'writing') renderWriting(data, container);
    }

    function shouldRenderQuestion(qid) {
        if (!isRetryMode) return true;
        return !correctIds.has(qid); 
    }

    window.toggleTrans = function(id) {
        const el = document.getElementById(id);
        const btn = document.getElementById('btn-' + id);
        if (el.style.display === 'block') { el.style.display = 'none'; btn.innerHTML = 'æŸ¥çœ‹ç¿»è¯‘'; } 
        else { el.style.display = 'block'; btn.innerHTML = 'æ”¶èµ·ç¿»è¯‘'; }
    };

    function escapeQuote(str) {
        return str.replace(/'/g, "\\'");
    }

    function renderChoice(data, container) {
        data.questions.forEach(q => {
            if (!shouldRenderQuestion(q.id)) return;
            const card = document.createElement('div');
            card.className = 'question-card';
            let html = `<div class="q-title">${q.id}. ${q.q}</div><div class="options-group">`;
            q.options.forEach(opt => {
                html += `<button class="option-btn" onclick="checkChoice(this, ${q.id}, '${escapeQuote(opt)}', '${escapeQuote(q.ans)}')">${opt}</button>`;
            });
            html += `</div><div class="analysis-box" id="exp-${q.id}">${q.exp}</div>`;
            card.innerHTML = html;
            container.appendChild(card);
            if (userResponses[q.id]) restoreChoiceState(card, q.id, q.ans);
        });
    }

    function renderSplitChoice(data, container) {
        const wrap = document.createElement('div'); wrap.className = 'split-layout';
        const left = document.createElement('div'); left.className = 'passage-panel';
        data.paragraphs.forEach((p, idx) => {
            const transId = `p-trans-${idx}`;
            left.innerHTML += `<p>${p.en}</p><span id="btn-${transId}" class="trans-toggle-btn" onclick="toggleTrans('${transId}')">æŸ¥çœ‹ç¿»è¯‘</span><div id="${transId}" class="para-trans">${p.cn}</div><hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">`;
        });
        const right = document.createElement('div'); right.className = 'questions-panel';
        renderChoice({questions: data.questions}, right);
        wrap.appendChild(left); wrap.appendChild(right); container.appendChild(wrap);
    }

    function renderSplitInput(data, container) {
        const wrap = document.createElement('div'); wrap.className = 'split-layout';
        const left = document.createElement('div'); left.className = 'passage-panel';
        data.paragraphs.forEach((p, idx) => {
            let processedEn = p.en.replace(/\[(\d+)\]\s*______/g, (match, id) => {
                if (isRetryMode && correctIds.has(parseInt(id))) {
                    const ans = data.questions.find(q => q.id == id).ans;
                    return `[${id}] <strong style="color:green; border-bottom:1px solid green;">${ans}</strong>`;
                }
                return `[${id}] <input type="text" class="inline-input" id="input-${id}" autocomplete="off">`;
            });
            const transId = `p-gram-trans-${idx}`;
            left.innerHTML += `<p>${processedEn}</p><span id="btn-${transId}" class="trans-toggle-btn" onclick="toggleTrans('${transId}')">æŸ¥çœ‹ç¿»è¯‘</span><div id="${transId}" class="para-trans">${p.cn}</div><hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">`;
        });
        const right = document.createElement('div'); right.className = 'questions-panel';
        data.questions.forEach(q => {
            if (!shouldRenderQuestion(q.id)) return;
            const card = document.createElement('div'); card.className = 'question-card';
            card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><strong>ç¬¬ ${q.id} é¢˜</strong><button class="check-btn" onclick="checkInput(${q.id}, '${escapeQuote(q.ans)}')">ç¡®è®¤</button></div><div class="analysis-box" id="exp-${q.id}"><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> ${q.ans}<br>${q.exp}</div>`;
            right.appendChild(card);
        });
        wrap.appendChild(left); wrap.appendChild(right); container.appendChild(wrap);
        setTimeout(() => restoreInputState(data.questions), 100);
    }

    function renderInputSentence(data, container) {
        data.questions.forEach(q => {
            if (!shouldRenderQuestion(q.id)) return;
            const card = document.createElement('div'); card.className = 'question-card';
            const qHtml = q.q.replace('______', `<input type="text" class="inline-input" id="input-${q.id}" style="width:250px" autocomplete="off">`);
            card.innerHTML = `<div class="q-title">${qHtml}</div><div style="margin-top:15px;"><button class="check-btn" onclick="checkInput(${q.id}, '${escapeQuote(q.ans)}')">ç¡®è®¤</button></div><div class="analysis-box" id="exp-${q.id}"><strong>å‚è€ƒç­”æ¡ˆï¼š</strong> ${q.ans}<br>${q.exp}</div>`;
            container.appendChild(card);
        });
        setTimeout(() => restoreInputState(data.questions), 100);
    }

    function renderWriting(data, container) {
        data.questions.forEach(q => {
            const card = document.createElement('div'); card.className = 'question-card';
            card.innerHTML = `<div class="q-title">${q.q}</div><textarea id="input-${q.id}" placeholder="è¯·åœ¨æ­¤å¤„ä½œç­”...ç‚¹å‡»è¾“å…¥æ¡†æŸ¥çœ‹å‚è€ƒèŒƒæ–‡"></textarea><div class="analysis-box" id="exp-${q.id}"><strong>å‚è€ƒèŒƒæ–‡ï¼š</strong><pre style="white-space: pre-wrap; font-family:inherit; color:#555;">${q.ans}</pre><br>${q.exp}</div>`;
            container.appendChild(card);
            
            setTimeout(() => {
                const area = document.getElementById(`input-${q.id}`);
                const exp = document.getElementById(`exp-${q.id}`);
                area.addEventListener('focus', function() {
                    exp.style.display = 'block';
                    userResponses[q.id] = { type: 'writing', userVal: area.value, isCorrect: true };
                });
                if (userResponses[q.id]) { 
                    area.value = userResponses[q.id].userVal; 
                    exp.style.display = 'block'; 
                }
            }, 0);
        });
    }

    window.checkChoice = function(btn, id, optStr, ansStr) {
        const parent = btn.parentElement; const allBtns = parent.querySelectorAll('button');
        const expDiv = document.getElementById(`exp-${id}`);
        allBtns.forEach(b => b.disabled = true);
        const isCorrect = optStr.startsWith(ansStr);
        if (isCorrect) { btn.classList.add('correct'); correctIds.add(id); } 
        else { btn.classList.add('wrong'); correctIds.delete(id); allBtns.forEach(b => { if(b.innerText.startsWith(ansStr)) b.classList.add('correct'); }); }
        expDiv.style.display = 'block';
        userResponses[id] = { type: 'choice', userChoice: optStr.charAt(0), isCorrect: isCorrect, ans: ansStr };
    };

    function restoreChoiceState(card, id, ansStr) {
        const btns = card.querySelectorAll('.option-btn');
        const exp = card.querySelector('.analysis-box');
        const userChoice = userResponses[id].userChoice;
        btns.forEach(btn => {
            btn.disabled = true;
            if(btn.innerText.startsWith(ansStr)) btn.classList.add('correct');
            if(btn.innerText.startsWith(userChoice) && !btn.innerText.startsWith(ansStr)) btn.classList.add('wrong');
        });
        exp.style.display = 'block';
    }

    window.checkInput = function(id, correctAns) {
        const input = document.getElementById(`input-${id}`);
        const expDiv = document.getElementById(`exp-${id}`);
        if(!input) return;
        const userVal = input.value.trim();
        if (!userVal) return alert("è¯·å…ˆå¡«å†™ç­”æ¡ˆï¼");
        // å®½æ¾åŒ¹é…ï¼šå¿½ç•¥å¤§å°å†™å’Œæ ‡ç‚¹
        const cleanUser = userVal.toLowerCase().replace(/[^a-z0-9]/g, '');
        const cleanAns = correctAns.toLowerCase().replace(/[^a-z0-9]/g, '');
        // åŒ…å«åˆ¤æ–­æˆ–å…¨ç­‰ï¼Œå…è®¸çŸ­å•è¯
        let isCorrect = (cleanUser === cleanAns) || (cleanAns.includes(cleanUser) && cleanUser.length > 3);
        
        if (isCorrect) { input.classList.add('correct'); correctIds.add(id); } 
        else { input.classList.add('wrong'); correctIds.delete(id); }
        input.disabled = true; expDiv.style.display = 'block';
        userResponses[id] = { type: 'input', userVal: userVal, isCorrect: isCorrect };
    };

    function restoreInputState(questions) {
        questions.forEach(q => {
            if (shouldRenderQuestion(q.id) && userResponses[q.id]) {
                const input = document.getElementById(`input-${q.id}`);
                const exp = document.getElementById(`exp-${q.id}`);
                if (input && exp) {
                    input.value = userResponses[q.id].userVal;
                    input.disabled = true;
                    exp.style.display = 'block';
                    input.classList.add(userResponses[q.id].isCorrect ? 'correct' : 'wrong');
                }
            }
        });
    }

    window.submitExam = function() {
        let score = 0;
        Object.values(userResponses).forEach(r => {
            if (r.type === 'writing') score += 15; 
            else if (r.isCorrect) score += (r.type === 'choice' ? 2 : 3);
        });
        document.getElementById('final-score').innerText = score;
        document.getElementById('result-modal').style.display = 'flex';
    };

    window.retryWrongMode = function() {
        isRetryMode = true;
        document.getElementById('result-modal').style.display = 'none';
        for (let key in userResponses) {
            if (!userResponses[key].isCorrect && userResponses[key].type !== 'writing') {
                delete userResponses[key];
            }
        }
        alert("å·²è¿›å…¥ã€é”™é¢˜é‡ç»ƒã€‘æ¨¡å¼ï¼Œåšå¯¹çš„é¢˜ç›®å·²è‡ªåŠ¨éšè—ã€‚");
        const activeItem = document.querySelector('.menu-item.active');
        if(activeItem) activeItem.click(); else showSection(0);
    };

</script>
</body>
</html>
