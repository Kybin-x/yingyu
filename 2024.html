<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2024å¹´å¹¿ä¸œé«˜èŒé«˜è€ƒè‹±è¯­ - å…¨çœŸæ¨¡æ‹Ÿç³»ç»Ÿ</title>
    <style>
        /* --- 2024ç‰ˆè§†è§‰é£æ ¼ --- */
        :root {
            --primary-color: #2980b9;       /* æ²‰ç¨³è“ */
            --secondary-color: #34495e;     /* æ·±ç° */
            --accent-color: #e67e22;        /* æ´»åŠ›æ©™ */
            --success-color: #27ae60;
            --error-color: #c0392b;
            --bg-color: #f0f2f5;
            --sidebar-width: 260px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
            line-height: 1.6;
        }

        /* --- ç§»åŠ¨ç«¯é€‚é…ç»„ä»¶ --- */
        .mobile-menu-btn {
            display: none;
            position: fixed; top: 15px; left: 15px; z-index: 200;
            background: var(--secondary-color); color: white;
            border: none; padding: 8px 12px; border-radius: 6px;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .mobile-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 150; backdrop-filter: blur(3px);
        }

        /* --- ç™»å½•å±‚ --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2980b9, #6dd5fa);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }

        .login-box {
            background: white; padding: 40px 30px; border-radius: 15px;
            width: 100%; max-width: 380px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .login-box h2 { margin-top: 0; color: var(--secondary-color); }
        .login-box input {
            width: 100%; padding: 12px; margin: 10px 0;
            border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 16px;
        }
        .login-box input:focus { border-color: var(--primary-color); outline: none; }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar {
            width: var(--sidebar-width); background-color: white;
            color: var(--secondary-color); display: flex; flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.05); z-index: 160;
            transition: transform 0.3s ease;
        }
        .user-info-display { padding: 30px 20px; background: #ecf0f1; border-bottom: 1px solid #ddd; }
        .sidebar-header-mobile { display: none; } 
        
        .menu-item {
            padding: 18px 25px; cursor: pointer; border-left: 5px solid transparent;
            font-weight: 500; color: #555; border-bottom: 1px solid #f9f9f9;
        }
        .menu-item:hover { background-color: #f4f6f7; }
        .menu-item.active { 
            background-color: #eaf2f8; border-left-color: var(--primary-color);
            color: var(--primary-color); font-weight: bold;
        }

        /* --- ä¸»å†…å®¹åŒº --- */
        .main-content {
            flex: 1; padding: 40px; overflow-y: auto;
            position: relative; scroll-behavior: smooth;
        }

        /* --- é¢˜ç›®å¡ç‰‡ --- */
        .question-card {
            background: white; padding: 30px; margin-bottom: 25px;
            border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .q-title { font-weight: 600; margin-bottom: 20px; font-size: 1.1em; color: #2c3e50; }

        /* --- é€‰é¡¹æŒ‰é’® --- */
        .options-group { display: grid; gap: 12px; }
        .option-btn {
            text-align: left; padding: 15px 20px; background: #f8f9fa;
            border: 1px solid #e9ecef; border-radius: 8px; cursor: pointer;
            font-size: 16px; color: #495057; transition: all 0.2s;
        }
        .option-btn:hover:not(:disabled) { background: #e2e6ea; }
        .option-btn.correct { background-color: #d4edda; border-color: var(--success-color); color: #155724; font-weight: bold; }
        .option-btn.wrong { background-color: #f8d7da; border-color: var(--error-color); color: #721c24; }

        /* --- åˆ†å±å¸ƒå±€ (é˜…è¯»/è¯­æ³•) --- */
        .split-layout { display: flex; gap: 30px; align-items: flex-start; height: calc(100vh - 120px); }
        .passage-panel {
            flex: 1; background: #fff; padding: 25px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow-y: auto; height: 100%;
            border-top: 4px solid var(--primary-color); line-height: 1.8; color: #444;
        }
        .questions-panel { flex: 1; overflow-y: auto; height: 100%; padding-right: 5px; }

        /* --- ç¿»è¯‘æ˜¾éšæ§åˆ¶ --- */
        .trans-toggle-btn {
            display: inline-block; margin-top: 8px; padding: 4px 10px;
            font-size: 0.85em; color: var(--primary-color); background: rgba(41, 128, 185, 0.1);
            border-radius: 4px; cursor: pointer;
        }
        .para-trans {
            display: none; margin-top: 10px; padding: 12px;
            background-color: #fcf8e3; border-left: 3px solid var(--accent-color);
            color: #666; font-size: 0.95em; border-radius: 0 4px 4px 0;
        }

        /* --- å¡«ç©ºè¾“å…¥æ¡† --- */
        .inline-input {
            border: none; border-bottom: 2px solid #bdc3c7; width: 100px;
            text-align: center; font-size: 1.1em; padding: 0 5px;
            background: #f4f6f9; color: #2c3e50; margin: 0 4px; border-radius: 4px 4px 0 0;
        }
        .inline-input:focus { outline: none; border-bottom-color: var(--primary-color); background: white; }
        .inline-input.correct { border-bottom-color: var(--success-color); color: var(--success-color); font-weight: bold; background: white; }
        .inline-input.wrong { border-bottom-color: var(--error-color); color: var(--error-color); background: #fff5f5; }

        /* --- è§£æåŒºåŸŸ --- */
        .analysis-box {
            margin-top: 20px; padding: 20px; background: #e8f4f8;
            border-radius: 8px; display: none; font-size: 0.95em; color: #34495e;
            border-left: 4px solid var(--primary-color);
        }
        .analysis-label { font-weight: bold; color: var(--primary-color); display: block; margin-bottom: 8px; }
        
        .check-btn {
            background: var(--secondary-color); color: white; border: none;
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;
        }

        /* --- æäº¤æŒ‰é’® --- */
        .submit-all-btn {
            position: fixed; bottom: 30px; right: 40px;
            background: var(--success-color); color: white; border: none;
            padding: 15px 35px; border-radius: 50px; font-size: 18px;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4); cursor: pointer; z-index: 100;
        }

        /* --- ç»“æœå¼¹çª— --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
            z-index: 2000; padding: 20px; box-sizing: border-box; backdrop-filter: blur(3px);
        }
        .result-card {
            background: white; padding: 40px; border-radius: 16px; text-align: center;
            width: 100%; max-width: 450px; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .score-num { font-size: 60px; color: var(--primary-color); font-weight: bold; display: block; margin: 15px 0; }
        .result-btns { display: flex; gap: 15px; justify-content: center; margin-top: 25px; }
        .res-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; color: white; }
        .btn-retry { background: var(--accent-color); }
        .btn-restart { background: var(--secondary-color); }
        
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 10px; font-size: 16px; box-sizing: border-box; }

        /* --- ç§»åŠ¨ç«¯å“åº”å¼ --- */
        @media (max-width: 768px) {
            body { font-size: 15px; } 
            .mobile-menu-btn { display: block; }
            .sidebar { position: fixed; top: 0; left: -100%; height: 100%; width: 80%; max-width: 300px; }
            .sidebar.active-mobile { left: 0; }
            .sidebar-header-mobile { display: flex; justify-content: flex-end; padding: 10px; }
            .close-menu-btn { background: none; border: none; color: #333; font-size: 24px; }
            .main-content { padding: 60px 15px 90px 15px; width: 100%; }
            .split-layout { flex-direction: column; height: auto; gap: 20px; }
            .passage-panel { width: 100%; height: auto; max-height: 40vh; border-top: none; border-left: 4px solid var(--primary-color); padding: 15px; box-sizing: border-box; }
            .questions-panel { width: 100%; height: auto; overflow: visible; padding-right: 0; }
            .inline-input { width: 80px; }
            .submit-all-btn { right: 50%; transform: translateX(50%); bottom: 20px; width: 85%; text-align: center; }
        }
    </style>
</head>
<body>

<div class="mobile-overlay" id="mobile-overlay" onclick="toggleSidebar()"></div>
<button class="mobile-menu-btn" onclick="toggleSidebar()">â˜° é¢˜ç›®ç›®å½•</button>

<div id="login-overlay">
    <div class="login-box">
        <h2>ğŸ“ 2024 é«˜èŒé«˜è€ƒè‹±è¯­</h2>
        <p style="color:#7f8c8d; margin-bottom:20px;">å…¨çœŸæ¨¡æ‹Ÿæ™ºèƒ½è®­ç»ƒ</p>
        <input type="text" id="u-class" placeholder="ç­çº§">
        <input type="text" id="u-id" placeholder="å­¦å·">
        <input type="text" id="u-name" placeholder="å§“å">
        <button onclick="login()" class="check-btn" style="width:100%; margin-top:20px; background:var(--primary-color); font-size:16px; padding:12px;">å¼€å§‹ç­”é¢˜</button>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header-mobile">
        <button class="close-menu-btn" onclick="toggleSidebar()">Ã—</button>
    </div>
    <div class="user-info-display">
        <h3 id="disp-name" style="margin:0">è€ƒç”Ÿ</h3>
        <p id="disp-id" style="margin:5px 0 0; font-size:0.9em; color:#666">--</p>
    </div>
    <div id="menu-container"></div>
</div>

<div class="main-content" id="main-area">
    <div id="content-container"></div>
</div>

<button class="submit-all-btn" onclick="submitExam()">æäº¤è¯•å·</button>

<div class="modal-overlay" id="result-modal">
    <div class="result-card">
        <h2>è€ƒè¯•ç»“æŸ</h2>
        <p>æ‚¨çš„å¾—åˆ†ä¸º</p>
        <span class="score-num" id="final-score">0</span>
        <div class="result-btns">
            <button class="res-btn btn-retry" onclick="retryWrongMode()">é”™é¢˜é‡ç»ƒ</button>
            <button class="res-btn btn-restart" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
        </div>
    </div>
</div>

<script>
    // ===============================================
    // 2024å¹´çœŸé¢˜æ•°æ®
    // ===============================================
    const examData = [
        {
            id: 'part1',
            title: "I. è¡¥å…¨å¯¹è¯",
            type: 'choice',
            desc: "é˜…è¯»ä¸‹åˆ—ç®€çŸ­å¯¹è¯ï¼Œä»Aã€Bã€Cã€Dä¸­é€‰å‡ºæœ€ä½³ç­”æ¡ˆã€‚",
            questions: [
                { id: 1, q: "â€” I'm sorry I lost the book you lent me.<br>â€” ______ I have another copy.", options: ["A. Don't worry", "B. I'm afraid not", "C. What a pity", "D. You'd better not"], ans: "A", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€å¥æ„ã€‘â€”å¾ˆæŠ±æ­‰æˆ‘å¼„ä¸¢äº†ä½ å€Ÿç»™æˆ‘çš„ä¹¦ã€‚<br>â€”åˆ«æ‹…å¿ƒã€‚æˆ‘è¿˜æœ‰ä¸€æœ¬ã€‚<br>ã€è§£æã€‘Aé¡¹æ„ä¸ºâ€œåˆ«æ‹…å¿ƒâ€ï¼Œç¬¦åˆè¯­å¢ƒä¸­å®½æ…°å¯¹æ–¹çš„è¯­æ°”ã€‚" },
                { id: 2, q: "â€” Do you mind me leaving now?<br>â€” ______. Have a nice weekend.", options: ["A. Yes, I do", "B. Good idea", "C. Of course not", "D. I don't agree"], ans: "C", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€å¥æ„ã€‘â€”ä½ ä»‹æ„æˆ‘ç°åœ¨ç¦»å¼€å—ï¼Ÿ<br>â€”å½“ç„¶ä¸ä»‹æ„ã€‚å‘¨æœ«æ„‰å¿«ã€‚<br>ã€è§£æã€‘å›ç­”â€œHave a nice weekendâ€æš—ç¤ºåŒæ„å¯¹æ–¹ç¦»å¼€ï¼Œé’ˆå¯¹Mind(ä»‹æ„)çš„æé—®ï¼Œä¸ä»‹æ„åº”å›ç­”â€œNoâ€æˆ–â€œOf course notâ€ã€‚" },
                { id: 3, q: "â€” Would you like to go to the beach this weekend? The weather is lovely.<br>â€” ______.", options: ["A. It depends", "B. I'm afraid so", "C. I don't care", "D. Sounds great"], ans: "D", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€å¥æ„ã€‘â€”è¿™ä¸ªå‘¨æœ«ä½ æƒ³å»æµ·æ»©å—ï¼Ÿå¤©æ°”å¾ˆå¥½ã€‚<br>â€”å¬èµ·æ¥å¾ˆæ£’ã€‚<br>ã€è§£æã€‘Dé¡¹â€œå¬èµ·æ¥å¾ˆæ£’â€æ˜¯æ¥å—å»ºè®®çš„å¸¸ç”¨è¯­ã€‚" },
                { id: 4, q: "â€” Thank you for taking care of my dog while I was away.<br>â€” ______.", options: ["A. It's my pleasure", "B. What a lovely dog", "C. You are so kind", "D. It doesn't matter"], ans: "A", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€å¥æ„ã€‘â€”è°¢è°¢ä½ åœ¨æˆ‘ä¸åœ¨çš„æ—¶å€™ç…§é¡¾æˆ‘çš„ç‹—ã€‚<br>â€”è¿™æ˜¯æˆ‘çš„è£å¹¸/åˆ«å®¢æ°”ã€‚<br>ã€è§£æã€‘å›åº”æ„Ÿè°¢å¸¸ç”¨â€œIt's my pleasureâ€æˆ–â€œYou're welcomeâ€ã€‚" },
                { id: 5, q: "â€” Sir, ______?<br>â€” Yes, I'd like chicken with rice.", options: ["A. what's your favorite food", "B. may I take your order", "C. would you like some drink", "D. do you like the food here"], ans: "B", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span>ã€å¥æ„ã€‘â€”å…ˆç”Ÿï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨ç‚¹é¤äº†å—ï¼Ÿ<br>â€”æ˜¯çš„ï¼Œæˆ‘æƒ³è¦é¸¡è‚‰é¥­ã€‚<br>ã€è§£æã€‘æ ¹æ®ç­”è¯­â€œYes, I'd like...â€å¯çŸ¥æ˜¯æœåŠ¡å‘˜è¯¢é—®æ˜¯å¦ç‚¹é¤ã€‚" }
            ]
        },
        {
            id: 'part2',
            title: "II. è¯æ±‡",
            type: 'choice',
            desc: "é€‰å‡ºå¥ä¸­ç”»çº¿å•è¯æˆ–è¯ç»„çš„æ„ä¹‰ã€‚",
            questions: [
                { id: 6, q: "There are only three <u>flights</u> a day to London.", options: ["A. æ—…è¡Œ", "B. èˆªç­", "C. åé¢", "D. æœºä¼š"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>flightï¼šèˆªç­ã€‚å¥æ„ï¼šæ¯å¤©åªæœ‰ä¸‰ç­é£å¾€ä¼¦æ•¦çš„èˆªç­ã€‚" },
                { id: 7, q: "We waited for him to give us the <u>signal</u> to move.", options: ["A. å‘½ä»¤", "B. è®¸å¯", "C. æ ‡å¿—", "D. ä¿¡å·"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>signalï¼šä¿¡å·ã€‚å¥æ„ï¼šæˆ‘ä»¬ç­‰ä»–ç»™æˆ‘ä»¬å‡ºå‘çš„ä¿¡å·ã€‚" },
                { id: 8, q: "John is a <u>professional</u> football player.", options: ["A. èŒä¸šçš„", "B. å®Œç¾çš„", "C. ä¸€æµçš„", "D. å›½é™…çš„"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>professionalï¼šèŒä¸šçš„ã€‚å¥æ„ï¼šçº¦ç¿°æ˜¯ä¸€åèŒä¸šè¶³çƒè¿åŠ¨å‘˜ã€‚" },
                { id: 9, q: "She closed her eyes and <u>pretended</u> to be asleep.", options: ["A. å‡è£…", "B. è¯•å›¾", "C. æƒ³è±¡", "D. å°½åŠ›"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>pretendï¼šå‡è£…ã€‚å¥æ„ï¼šå¥¹é—­ä¸Šçœ¼ç›ï¼Œå‡è£…ç¡ç€äº†ã€‚" },
                { id: 10, q: "<u>Traditionally</u>, children receive lucky money during the Spring Festival.", options: ["A. ä¹ æƒ¯ä¸Š", "B. å¤§ä½“ä¸Š", "C. ä¼ ç»Ÿä¸Š", "D. ä¸»è§‚ä¸Š"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>traditionallyï¼šä¼ ç»Ÿä¸Šã€‚å¥æ„ï¼šä¼ ç»Ÿä¸Šï¼Œå­©å­ä»¬åœ¨æ˜¥èŠ‚æœŸé—´ä¼šæ”¶åˆ°å‹å²é’±ã€‚" },
                { id: 11, q: "He promised to come at the weekend and he <u>kept his word</u>.", options: ["A. è¨€è¡Œä¸ä¸€", "B. ä¿¡å®ˆè¯ºè¨€", "C. æ²‰é»˜ä¸è¯­", "D. ä¿¡å£å¼€æ²³"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>keep one's wordï¼šä¿¡å®ˆè¯ºè¨€ã€‚å¥æ„ï¼šä»–ç­”åº”å‘¨æœ«æ¥ï¼Œä»–éµå®ˆäº†è¯ºè¨€ã€‚" },
                { id: 12, q: "The couple <u>raised</u> a baby girl.", options: ["A. å…»è‚²", "B. å…„å¼Ÿ", "C. çˆ¶æ¯", "D. å§å¦¹"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>raiseï¼šæŠšå…»ï¼Œå…»è‚²ã€‚å¥æ„ï¼šè¿™å¯¹å¤«å¦‡æ”¶å…»/æŠšå…»äº†ä¸€åå¥³å©´ã€‚" },
                { id: 13, q: "There has been a rapid increase in oil <u>exports</u>.", options: ["A. èµ„æº", "B. å‡ºå£", "C. æŠ¥å‘Š", "D. ä»·æ ¼"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>exportï¼šå‡ºå£ã€‚å¥æ„ï¼šçŸ³æ²¹å‡ºå£é‡è¿…é€Ÿå¢åŠ ã€‚" },
                { id: 14, "q": "The mother <u>brought up</u> three children on her own.", "options": ["A. å® çˆ±", "B. å¸¦æ¥", "C. æŠšå…»", "D. æ‰¹è¯„"], "ans": "C", exp: "<span class='analysis-label'>è§£æ</span>bring upï¼šæŠšå…»ã€‚å¥æ„ï¼šè¿™ä½æ¯äº²ç‹¬è‡ªæŠšå…»äº†ä¸‰ä¸ªå­©å­ã€‚" },
                { id: 15, "q": "How many guests are there <u>in total</u>?", "options": ["A. ç©¶ç«Ÿ", "B. å¤§æ¦‚", "C. è‡³å°‘", "D. æ€»å…±"], "ans": "D", exp: "<span class='analysis-label'>è§£æ</span>in totalï¼šæ€»å…±ã€‚å¥æ„ï¼šæ€»å…±æœ‰å¤šå°‘å®¢äººï¼Ÿ" }
            ]
        },
        {
            id: 'part3',
            title: "III. å®Œå½¢å¡«ç©º",
            type: 'split_choice',
            desc: "é˜…è¯»çŸ­æ–‡ï¼Œä»æ¯é¢˜æ‰€ç»™çš„å››ä¸ªé€‰é¡¹ä¸­é€‰å‡ºæœ€ä½³é€‰é¡¹ã€‚(æ•…äº‹èƒŒæ™¯ï¼šè€æ°´é¸Ÿä¸èƒèŸ¹)",
            paragraphs: [
                { en: "An old water bird was feeling [16] because he was too old to catch fish. He [17] a crab and had an idea. He pretended to be [18] the fish in the pond.", cn: "ã€è¯‘æ–‡ã€‘ä¸€åªè€æ°´é¸Ÿæ„Ÿåˆ°[16]ä¼¤å¿ƒ(sad)ï¼Œå› ä¸ºä»–å¤ªè€äº†æŠ“ä¸åˆ°é±¼ã€‚ä»–[17]æ³¨æ„åˆ°äº†(noticed)ä¸€åªèƒèŸ¹ï¼Œæƒ³åˆ°äº†ä¸€ä¸ªä¸»æ„ã€‚ä»–å‡è£…[18]åŒæƒ…(sorry for)æ± å¡˜é‡Œçš„é±¼ã€‚" },
                { en: "The fish thought he was [19], so they asked him why he was [20]. The bird said, \"The fisherman will empty this pond soon. It will be [21] for you.\"", cn: "ã€è¯‘æ–‡ã€‘é±¼å„¿ä»¬è®¤ä¸ºä»–æ˜¯[19]æ˜æ™ºçš„(wise)ï¼Œæ‰€ä»¥é—®ä»–ä¸ºä»€ä¹ˆ[20]æ‹…å¿ƒ(worried)ã€‚é¸Ÿè¯´ï¼šâ€œæ¸”å¤«å¾ˆå¿«å°±ä¼šæŠŠè¿™ä¸ªæ± å¡˜å¼„å¹²ã€‚è¿™å¯¹ä½ ä»¬æ¥è¯´å°†æ˜¯[21]ç³Ÿç³•çš„(bad)ã€‚â€" },
                { en: "The fish were [22]. The bird offered to [23] them to another pond. But it was actually a [24] to eat them. He took them one by one and ate them for [25].", cn: "ã€è¯‘æ–‡ã€‘é±¼å„¿ä»¬æ„Ÿåˆ°[22]å®³æ€•(frightened)ã€‚é¸Ÿæè®®[23]å¸¦(take)å®ƒä»¬å»å¦ä¸€ä¸ªæ± å¡˜ã€‚ä½†è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªåƒæ‰å®ƒä»¬çš„[24]è®¡åˆ’(plan)ã€‚ä»–æŠŠå®ƒä»¬ä¸€ä¸ªä¸ªå¸¦èµ°ï¼Œå½“ä½œ[25]æ™šé¤(dinner)åƒæ‰äº†ã€‚" },
                { en: "Soon he got [26] of eating fish. He decided to eat the [27]. The crab saw the pile of fish bones and realized the [28].", cn: "ã€è¯‘æ–‡ã€‘å¾ˆå¿«ä»–åƒé±¼åƒ[26]è…»äº†(tired)ã€‚ä»–å†³å®šåƒé‚£åª[27]èƒèŸ¹(crab)ã€‚èƒèŸ¹çœ‹åˆ°äº†ä¸€å †é±¼éª¨å¤´ï¼Œæ„è¯†åˆ°äº†[28]å±é™©(danger)ã€‚" },
                { en: "Before the [29] bird could eat him, the crab killed the bird. The bad bird [30] dead into the water.", cn: "ã€è¯‘æ–‡ã€‘åœ¨[29]è€(old)é¸Ÿåƒæ‰ä»–ä¹‹å‰ï¼ŒèƒèŸ¹æ€æ­»äº†é¸Ÿã€‚é‚£åªåé¸Ÿ[30]å€’(fell)åœ¨æ°´é‡Œæ­»äº†ã€‚" }
            ],
            questions: [
                { id: 16, options: ["A. happy", "B. excited", "C. sad", "D. lucky"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>é¸ŸæŠ“ä¸åˆ°é±¼ï¼Œæ‰€ä»¥æ„Ÿåˆ°ä¼¤å¿ƒ(sad)ã€‚" },
                { id: 17, options: ["A. helped", "B. ate", "C. called", "D. noticed"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>ä»–æ³¨æ„åˆ°äº†(noticed)ä¸€åªèƒèŸ¹ã€‚" },
                { id: 18, options: ["A. angry with", "B. proud of", "C. happy for", "D. sorry for"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>be sorry for è¡¨ç¤ºâ€œåŒæƒ…ï¼Œä¸º...éš¾è¿‡â€ã€‚" },
                { id: 19, options: ["A. foolish", "B. wise", "C. lazy", "D. young"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>é±¼ä»¥ä¸ºè€é¸Ÿè§å¤šè¯†å¹¿ï¼Œæ˜¯æ˜æ™ºçš„(wise)ã€‚" },
                { id: 20, options: ["A. worried", "B. excited", "C. tired", "D. rich"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>é¸Ÿçœ‹èµ·æ¥å¾ˆå¿§è™‘(worried)ã€‚" },
                { id: 21, options: ["A. good", "B. bad", "C. safe", "D. easy"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>æ± å¡˜å¹²äº†å¯¹é±¼æ˜¯åäº‹(bad)ã€‚" },
                { id: 22, options: ["A. happy", "B. bored", "C. frightened", "D. brave"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>é±¼å¬åˆ°è¿™ä¸ªæ¶ˆæ¯æ„Ÿåˆ°å®³æ€•(frightened)ã€‚" },
                { id: 23, options: ["A. take", "B. sell", "C. cook", "D. show"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>take...to... æŠŠ...å¸¦å»..." },
                { id: 24, options: ["A. joke", "B. plan", "C. dream", "D. game"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>è¿™æ˜¯ä¸€ä¸ªé˜´è°‹/è®¡åˆ’(plan)ã€‚" },
                { id: 25, options: ["A. fun", "B. free", "C. dinner", "D. pet"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>for dinner ä½œä¸ºæ™šé¤ã€‚" },
                { id: 26, options: ["A. full", "B. fond", "C. afraid", "D. tired"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>get tired of åŒå€¦äº†åšæŸäº‹ã€‚" },
                { id: 27, options: ["A. fish", "B. bird", "C. crab", "D. frog"], ans: "C", exp: "<span class='analysis-label'>è§£æ</span>æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œä»–å†³å®šåƒèƒèŸ¹(crab)ã€‚" },
                { id: 28, options: ["A. truth", "B. lie", "C. mistake", "D. danger"], ans: "D", exp: "<span class='analysis-label'>è§£æ</span>èƒèŸ¹çœ‹åˆ°äº†éª¨å¤´ï¼Œæ„è¯†åˆ°äº†å±é™©(danger)ã€‚" },
                { id: 29, options: ["A. old", "B. young", "C. kind", "D. small"], ans: "A", exp: "<span class='analysis-label'>è§£æ</span>æŒ‡ä»£é‚£åªè€(old)é¸Ÿã€‚" },
                { id: 30, options: ["A. flew", "B. fell", "C. jumped", "D. swam"], ans: "B", exp: "<span class='analysis-label'>è§£æ</span>é¸Ÿå€’ä¸‹(fell)æ­»äº†ã€‚" }
            ]
        },
        {
            id: 'part5',
            title: "V. è¯­æ³•å¡«ç©º",
            type: 'split_input',
            desc: "é˜…è¯»ä¸‹é¢çŸ­æ–‡ï¼Œåœ¨ç©ºæ ¼å¤„å¡«å…¥é€‚å½“çš„è¯ã€‚(æ•…äº‹èƒŒæ™¯ï¼šMaryçš„èŒåœºå›°æƒ‘ä¸ç»ç†Carolçš„å»ºè®®)",
            paragraphs: [
                { en: "Mary worked hard in her company, but no one seemed to like [46] ______. She had many [47] ______ (problem) with her colleagues. One day, her manager Carol asked her [48] ______ (attend) a meeting.", cn: "ã€è¯‘æ–‡ã€‘Maryåœ¨å…¬å¸å·¥ä½œå¾ˆåŠªåŠ›ï¼Œä½†ä¼¼ä¹æ²¡äººå–œæ¬¢[46]å¥¹(her)ã€‚å¥¹å’ŒåŒäº‹ä¹‹é—´æœ‰å¾ˆå¤š[47]é—®é¢˜(problems)ã€‚ä¸€å¤©ï¼Œç»ç†Carolè®©å¥¹[48]å‚åŠ (to attend)ä¸€ä¸ªä¼šè®®ã€‚" },
                { en: "While she [49] ______ (have) lunch, she thought about her situation. She felt very [50] ______ (happy). She went to Carol and asked [51] ______ she should do.", cn: "ã€è¯‘æ–‡ã€‘å½“å¥¹[49]æ­£åœ¨åƒ(was having)åˆé¥­æ—¶ï¼Œå¥¹æ€è€ƒäº†è‡ªå·±çš„å¤„å¢ƒã€‚å¥¹æ„Ÿåˆ°éå¸¸[50]ä¸å¿«ä¹(unhappy)ã€‚å¥¹å»æ‰¾Carolï¼Œé—®[51]ä»€ä¹ˆ(what)æ˜¯å¥¹è¯¥åšçš„ã€‚" },
                { en: "Carol didn't speak but pointed [52] ______ a pot on the stove. The water [53] ______ (ask) to boil. Carol put an egg in it. \"Life is hard, [54] ______ you must be strong like this egg,\" Carol said.", cn: "ã€è¯‘æ–‡ã€‘Carolæ²¡è¯´è¯ï¼Œè€Œæ˜¯æŒ‡å‘[52](to)ç‚‰å­ä¸Šçš„ä¸€ä¸ªé”…ã€‚æ°´[53]è¢«è¦æ±‚(was asked)çƒ§å¼€ã€‚Carolæ”¾äº†ä¸ªé¸¡è›‹è¿›å»ã€‚â€œç”Ÿæ´»å¾ˆéš¾ï¼Œ[54]ä½†æ˜¯(but)ä½ å¿…é¡»åƒè¿™ä¸ªé¸¡è›‹ä¸€æ ·åšå¼ºï¼Œâ€Carolè¯´ã€‚" },
                { en: "After a while, the egg [55] ______ (boil) hard. Mary understood that difficulties can make one stronger.", cn: "ã€è¯‘æ–‡ã€‘è¿‡äº†ä¸€ä¼šå„¿ï¼Œé¸¡è›‹[55]ç…®(boiled)ç¡¬äº†ã€‚Maryæ˜ç™½äº†å›°éš¾å¯ä»¥è®©äººæ›´åšå¼ºã€‚" }
            ],
            questions: [
                { id: 46, ans: "her", exp: "<span class='analysis-label'>è§£æ</span>åŠ¨è¯likeåæ¥äººç§°ä»£è¯å®¾æ ¼ herã€‚" },
                { id: 47, ans: "problems", exp: "<span class='analysis-label'>è§£æ</span>manyä¿®é¥°å¯æ•°åè¯å¤æ•° problemsã€‚" },
                { id: 48, ans: "to attend", exp: "<span class='analysis-label'>è§£æ</span>ask sb to do sth è¦æ±‚æŸäººåšæŸäº‹ã€‚" },
                { id: 49, ans: "was having", exp: "<span class='analysis-label'>è§£æ</span>whileå¼•å¯¼çš„æ—¶é—´çŠ¶è¯­ï¼Œè¡¨ç¤ºè¿‡å»æ­£åœ¨è¿›è¡Œï¼Œç”¨ was havingã€‚" },
                { id: 50, ans: "unhappy", exp: "<span class='analysis-label'>è§£æ</span>æ ¹æ®è¯­å¢ƒï¼Œå¥¹é‡åˆ°å›°éš¾ï¼Œåº”æ„Ÿåˆ°â€œä¸å¿«ä¹â€ï¼Œå¡« happy çš„åä¹‰è¯ unhappyã€‚" },
                { id: 51, ans: "what", exp: "<span class='analysis-label'>è§£æ</span>å¼•å¯¼å®¾è¯­ä»å¥ï¼Œä¸”åœ¨ä»å¥ä¸­ä½œ do çš„å®¾è¯­ï¼Œå¡« whatã€‚" },
                { id: 52, ans: "to", exp: "<span class='analysis-label'>è§£æ</span>point to æŒ‡å‘ã€‚" },
                { id: 53, ans: "was asked", exp: "<span class='analysis-label'>è§£æ</span>æ°´æ˜¯è¢«è¦æ±‚çƒ§å¼€çš„ï¼Œè¢«åŠ¨è¯­æ€ was askedã€‚" },
                { id: 54, ans: "but", exp: "<span class='analysis-label'>è§£æ</span>å‰åå¥æ„è½¬æŠ˜ï¼Œâ€œç”Ÿæ´»å¾ˆéš¾ï¼Œä½†ä½ å¿…é¡»åšå¼ºâ€ï¼Œå¡« butã€‚" },
                { id: 55, ans: "boiled", exp: "<span class='analysis-label'>è§£æ</span>æè¿°è¿‡å»å‘ç”Ÿçš„äº‹ï¼Œç”¨è¿‡å»å¼ boiledã€‚" }
            ]
        },
        {
            id: 'part6',
            title: "VI. å®Œæˆå¥å­",
            type: 'input_sentence',
            desc: "æ ¹æ®æ‰€ç»™æ±‰è¯­æç¤ºï¼Œå®Œæˆè‹±è¯­å¥å­ã€‚",
            questions: [
                { id: 56, q: "56. (å› ä¸ºä½ å·²ç»æ˜¯ä¸ªæˆå¹´äººäº†) ______ , you should take responsibility.", ans: "Because you're an adult now", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span><br>ã€å¥æ„ã€‘å› ä¸ºä½ ç°åœ¨æ˜¯ä¸ªæˆå¹´äººäº†ï¼Œä½ åº”è¯¥æ‰¿æ‹…è´£ä»»ã€‚<br>ã€è§£æã€‘Because å¼•å¯¼åŸå› çŠ¶è¯­ä»å¥ã€‚" },
                { id: 57, q: "57. (å¦‚æœä½ èƒ½å¸®åŠ©ä»–) ______, he will be grateful.", ans: "If you can help him", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span><br>ã€å¥æ„ã€‘å¦‚æœä½ èƒ½å¸®åŠ©ä»–ï¼Œä»–ä¼šå¾ˆæ„Ÿæ¿€ã€‚<br>ã€è§£æã€‘If å¼•å¯¼æ¡ä»¶çŠ¶è¯­ä»å¥ã€‚" },
                { id: 58, q: "58. The bad news ______ (ä½¿ä»–å¾ˆä¼¤å¿ƒ).", ans: "made him very sad", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span><br>ã€å¥æ„ã€‘è¿™ä¸ªåæ¶ˆæ¯ä½¿ä»–å¾ˆä¼¤å¿ƒã€‚<br>ã€è§£æã€‘make sb + adj. ç»“æ„ï¼Œè¿‡å»å¼ç”¨ madeã€‚" },
                { id: 59, q: "59. ______ (æˆ‘ç»™Tomè®²äº†ä¸ªæ•…äº‹) yesterday.", ans: "I told Tom a story", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span><br>ã€å¥æ„ã€‘æˆ‘æ˜¨å¤©ç»™Tomè®²äº†ä¸ªæ•…äº‹ã€‚<br>ã€è§£æã€‘tell sb sth åŒå®¾è¯­ç»“æ„ï¼Œæ—¶é—´æ˜¯æ˜¨å¤©ï¼Œç”¨è¿‡å»å¼ toldã€‚" },
                { id: 60, q: "60. It is fun ______ (åœ¨æ“åœºä¸Šæ‰“ç¯®çƒ).", ans: "to play basketball on the playground", exp: "<span class='analysis-label'>è§£æä¸ç¿»è¯‘</span><br>ã€å¥æ„ã€‘åœ¨æ“åœºä¸Šæ‰“ç¯®çƒå¾ˆæœ‰è¶£ã€‚<br>ã€è§£æã€‘It is + adj + to do sth å¥å‹ã€‚" }
            ]
        },
        {
            id: 'part7',
            title: "VII. åº”ç”¨å†™ä½œ",
            type: 'writing',
            desc: "è¯·åœ¨ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­è¾“å…¥ä½œæ–‡ã€‚ç‚¹å‡»è¾“å…¥æ¡†æŸ¥çœ‹å‚è€ƒèŒƒæ–‡ã€‚",
            questions: [
                { id: 61, q: "61. å‡å®šä½ æ˜¯æåã€‚ä½ çš„å¤–å›½æœ‹å‹Tomå¯’å‡æƒ³æ¥ä¸­å›½ä½“éªŒç”Ÿæ´»ï¼Œè¯·ä½ å†™ä¸€å°é‚®ä»¶é‚€è¯·ä»–æ¥ä½ å®¶ä½ã€‚å†…å®¹åŒ…æ‹¬ï¼š1. å‘å‡ºé‚€è¯·ï¼›2. æè®®æ´»åŠ¨ï¼ˆå‚è§‚å…¬å›­ã€å“å°ç¾é£Ÿï¼‰ï¼›3. è¡¨è¾¾æœŸå¾…ã€‚ï¼ˆçº¦40è¯ï¼‰", ans: "Dear Tom,\nI'm Li Hua. The winter vacation is coming. I wonder if I have the honor to invite you to come and live in my house for a while. First, we can go to visit the local park and share local delicious food. In addition, we can discuss different culture between us. I hope you can accept my invitation if it is convenient to you.\nYours,\nLi Hua", exp: "<span class='analysis-label'>å‚è€ƒèŒƒæ–‡ç¿»è¯‘</span><br>äº²çˆ±çš„Tomï¼Œæˆ‘æ˜¯æåã€‚å¯’å‡å¿«åˆ°äº†ã€‚æˆ‘æƒ³çŸ¥é“æˆ‘æ˜¯å¦æœ‰å¹¸é‚€è¯·ä½ æ¥æˆ‘å®¶ä½ä¸€æ®µæ—¶é—´ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å»å‚è§‚å½“åœ°çš„å…¬å›­ï¼Œåˆ†äº«å½“åœ°çš„ç¾é£Ÿã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥è®¨è®ºæˆ‘ä»¬ä¹‹é—´ä¸åŒçš„æ–‡åŒ–ã€‚å¦‚æœæ–¹ä¾¿çš„è¯ï¼Œå¸Œæœ›ä½ èƒ½æ¥å—æˆ‘çš„é‚€è¯·ã€‚<br>ä½ çš„ï¼Œæå" }
            ]
        }
    ];

    // ===============================================
    // é€»è¾‘æ§åˆ¶ (æ ¸å¿ƒ)
    // ===============================================
    let userResponses = {}; 
    let isRetryMode = false;
    let correctIds = new Set(); 

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');
        if (sidebar.classList.contains('active-mobile')) {
            sidebar.classList.remove('active-mobile');
            overlay.style.display = 'none';
        } else {
            sidebar.classList.add('active-mobile');
            overlay.style.display = 'block';
        }
    }

    function login() {
        const cls = document.getElementById('u-class').value;
        const name = document.getElementById('u-name').value;
        if (!cls || !name) return alert("è¯·è¾“å…¥ç­çº§å’Œå§“å");
        
        document.getElementById('disp-name').innerText = name;
        document.getElementById('disp-id').innerText = cls + "ç­";
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('sidebar').style.display = 'flex';
        document.getElementById('main-area').style.display = 'block';
        
        initMenu();
        showSection(0);
    }

    function initMenu() {
        const container = document.getElementById('menu-container');
        container.innerHTML = '';
        examData.forEach((part, index) => {
            const item = document.createElement('div');
            item.className = 'menu-item';
            item.innerHTML = part.title;
            item.onclick = () => {
                showSection(index);
                if(window.innerWidth <= 768) toggleSidebar();
            };
            container.appendChild(item);
        });
    }

    function showSection(index) {
        const container = document.getElementById('content-container');
        container.innerHTML = ''; 
        document.querySelectorAll('.menu-item').forEach((el, i) => {
            el.classList.toggle('active', i === index);
        });
        const data = examData[index];
        const title = document.createElement('h2');
        title.innerHTML = data.title + (isRetryMode ? " <span style='color:red;font-size:0.6em'>(é”™é¢˜é‡ç»ƒ)</span>" : "");
        container.appendChild(title);
        if(data.desc) {
            const desc = document.createElement('p');
            desc.innerHTML = data.desc; desc.style.color = '#666'; container.appendChild(desc);
        }
        if (data.type === 'choice') renderChoice(data, container);
        else if (data.type === 'split_choice') renderSplitChoice(data, container);
        else if (data.type === 'split_input') renderSplitInput(data, container);
        else if (data.type === 'input_sentence') renderInputSentence(data, container);
        else if (data.type === 'writing') renderWriting(data, container);
    }

    function shouldRenderQuestion(qid) {
        if (!isRetryMode) return true;
        return !correctIds.has(qid); 
    }

    window.toggleTrans = function(id) {
        const el = document.getElementById(id);
        const btn = document.getElementById('btn-' + id);
        if (el.style.display === 'block') { el.style.display = 'none'; btn.innerHTML = 'æŸ¥çœ‹ç¿»è¯‘'; } 
        else { el.style.display = 'block'; btn.innerHTML = 'æ”¶èµ·ç¿»è¯‘'; }
    };

    // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†å­—ç¬¦ä¸²ä¸­çš„å•å¼•å·ï¼Œé˜²æ­¢ HTML å±æ€§æˆªæ–­
    function escapeQuote(str) {
        return str.replace(/'/g, "\\'");
    }

    function renderChoice(data, container) {
        data.questions.forEach(q => {
            if (!shouldRenderQuestion(q.id)) return;
            const card = document.createElement('div');
            card.className = 'question-card';
            let html = `<div class="q-title">${q.id}. ${q.q}</div><div class="options-group">`;
            q.options.forEach(opt => {
                html += `<button class="option-btn" onclick="checkChoice(this, ${q.id}, '${escapeQuote(opt)}', '${escapeQuote(q.ans)}')">${opt}</button>`;
            });
            html += `</div><div class="analysis-box" id="exp-${q.id}">${q.exp}</div>`;
            card.innerHTML = html;
            container.appendChild(card);
            if (userResponses[q.id]) restoreChoiceState(card, q.id, q.ans);
        });
    }

    function renderSplitChoice(data, container) {
        const wrap = document.createElement('div'); wrap.className = 'split-layout';
        const left = document.createElement('div'); left.className = 'passage-panel';
        data.paragraphs.forEach((p, idx) => {
            const transId = `p-trans-${idx}`;
            left.innerHTML += `<p>${p.en}</p><span id="btn-${transId}" class="trans-toggle-btn" onclick="toggleTrans('${transId}')">æŸ¥çœ‹ç¿»è¯‘</span><div id="${transId}" class="para-trans">${p.cn}</div><hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">`;
        });
        const right = document.createElement('div'); right.className = 'questions-panel';
        renderChoice({questions: data.questions}, right);
        wrap.appendChild(left); wrap.appendChild(right); container.appendChild(wrap);
    }

    function renderSplitInput(data, container) {
        const wrap = document.createElement('div'); wrap.className = 'split-layout';
        const left = document.createElement('div'); left.className = 'passage-panel';
        data.paragraphs.forEach((p, idx) => {
            let processedEn = p.en.replace(/\[(\d+)\]\s*______/g, (match, id) => {
                if (isRetryMode && correctIds.has(parseInt(id))) {
                    const ans = data.questions.find(q => q.id == id).ans;
                    return `[${id}] <strong style="color:green; border-bottom:1px solid green;">${ans}</strong>`;
                }
                return `[${id}] <input type="text" class="inline-input" id="input-${id}" autocomplete="off">`;
            });
            const transId = `p-gram-trans-${idx}`;
            left.innerHTML += `<p>${processedEn}</p><span id="btn-${transId}" class="trans-toggle-btn" onclick="toggleTrans('${transId}')">æŸ¥çœ‹ç¿»è¯‘</span><div id="${transId}" class="para-trans">${p.cn}</div><hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">`;
        });
        const right = document.createElement('div'); right.className = 'questions-panel';
        data.questions.forEach(q => {
            if (!shouldRenderQuestion(q.id)) return;
            const card = document.createElement('div'); card.className = 'question-card';
            card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><strong>ç¬¬ ${q.id} é¢˜</strong><button class="check-btn" onclick="checkInput(${q.id}, '${escapeQuote(q.ans)}')">ç¡®è®¤</button></div><div class="analysis-box" id="exp-${q.id}"><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> ${q.ans}<br>${q.exp}</div>`;
            right.appendChild(card);
        });
        wrap.appendChild(left); wrap.appendChild(right); container.appendChild(wrap);
        setTimeout(() => restoreInputState(data.questions), 100);
    }

    function renderInputSentence(data, container) {
        data.questions.forEach(q => {
            if (!shouldRenderQuestion(q.id)) return;
            const card = document.createElement('div'); card.className = 'question-card';
            const qHtml = q.q.replace('______', `<input type="text" class="inline-input" id="input-${q.id}" style="width:250px" autocomplete="off">`);
            // ä¿®å¤ç¬¬56é¢˜BUGçš„å…³é”®ï¼šä½¿ç”¨ escapeQuote å¤„ç† q.ans
            card.innerHTML = `<div class="q-title">${qHtml}</div><div style="margin-top:15px;"><button class="check-btn" onclick="checkInput(${q.id}, '${escapeQuote(q.ans)}')">ç¡®è®¤</button></div><div class="analysis-box" id="exp-${q.id}"><strong>å‚è€ƒç­”æ¡ˆï¼š</strong> ${q.ans}<br>${q.exp}</div>`;
            container.appendChild(card);
        });
        setTimeout(() => restoreInputState(data.questions), 100);
    }

    function renderWriting(data, container) {
        data.questions.forEach(q => {
            const card = document.createElement('div'); card.className = 'question-card';
            // å†™ä½œé¢˜é€»è¾‘ä¼˜åŒ–ï¼šç‚¹å‡»æ–‡æœ¬æ¡†å³æ˜¾ç¤ºèŒƒæ–‡ï¼Œå»æ‰æäº¤æŒ‰é’®
            card.innerHTML = `<div class="q-title">${q.q}</div><textarea id="input-${q.id}" placeholder="è¯·åœ¨æ­¤å¤„ä½œç­”...ç‚¹å‡»è¾“å…¥æ¡†æŸ¥çœ‹å‚è€ƒèŒƒæ–‡"></textarea><div class="analysis-box" id="exp-${q.id}"><strong>å‚è€ƒèŒƒæ–‡ï¼š</strong><pre style="white-space: pre-wrap; font-family:inherit; color:#555;">${q.ans}</pre><br>${q.exp}</div>`;
            container.appendChild(card);
            
            // ç»‘å®šäº‹ä»¶ï¼šç‚¹å‡»æ—¶æ˜¾ç¤º
            setTimeout(() => {
                const area = document.getElementById(`input-${q.id}`);
                const exp = document.getElementById(`exp-${q.id}`);
                area.addEventListener('focus', function() {
                    exp.style.display = 'block';
                    userResponses[q.id] = { type: 'writing', userVal: area.value, isCorrect: true };
                });
                
                if (userResponses[q.id]) { 
                    area.value = userResponses[q.id].userVal; 
                    exp.style.display = 'block'; 
                }
            }, 0);
        });
    }

    window.checkChoice = function(btn, id, optStr, ansStr) {
        const parent = btn.parentElement; const allBtns = parent.querySelectorAll('button');
        const expDiv = document.getElementById(`exp-${id}`);
        allBtns.forEach(b => b.disabled = true);
        const isCorrect = optStr.startsWith(ansStr);
        if (isCorrect) { btn.classList.add('correct'); correctIds.add(id); } 
        else { btn.classList.add('wrong'); correctIds.delete(id); allBtns.forEach(b => { if(b.innerText.startsWith(ansStr)) b.classList.add('correct'); }); }
        expDiv.style.display = 'block';
        userResponses[id] = { type: 'choice', userChoice: optStr.charAt(0), isCorrect: isCorrect, ans: ansStr };
    };

    function restoreChoiceState(card, id, ansStr) {
        const btns = card.querySelectorAll('.option-btn');
        const exp = card.querySelector('.analysis-box');
        const userChoice = userResponses[id].userChoice;
        btns.forEach(btn => {
            btn.disabled = true;
            if(btn.innerText.startsWith(ansStr)) btn.classList.add('correct');
            if(btn.innerText.startsWith(userChoice) && !btn.innerText.startsWith(ansStr)) btn.classList.add('wrong');
        });
        exp.style.display = 'block';
    }

    window.checkInput = function(id, correctAns) {
        const input = document.getElementById(`input-${id}`);
        const expDiv = document.getElementById(`exp-${id}`);
        if(!input) return;
        const userVal = input.value.trim();
        if (!userVal) return alert("è¯·å…ˆå¡«å†™ç­”æ¡ˆï¼");
        // å®½æ¾åŒ¹é…
        const cleanUser = userVal.toLowerCase().replace(/[^a-z0-9]/g, '');
        const cleanAns = correctAns.toLowerCase().replace(/[^a-z0-9]/g, '');
        // ç®€å•åŒ…å«æˆ–å…¨ç­‰é€»è¾‘
        let isCorrect = (cleanUser === cleanAns) || (cleanUser.length > 5 && cleanAns.includes(cleanUser));
        
        if (isCorrect) { input.classList.add('correct'); correctIds.add(id); } 
        else { input.classList.add('wrong'); correctIds.delete(id); }
        input.disabled = true; expDiv.style.display = 'block';
        userResponses[id] = { type: 'input', userVal: userVal, isCorrect: isCorrect };
    };

    function restoreInputState(questions) {
        questions.forEach(q => {
            if (shouldRenderQuestion(q.id) && userResponses[q.id]) {
                const input = document.getElementById(`input-${q.id}`);
                const exp = document.getElementById(`exp-${q.id}`);
                if (input && exp) {
                    input.value = userResponses[q.id].userVal;
                    input.disabled = true;
                    exp.style.display = 'block';
                    input.classList.add(userResponses[q.id].isCorrect ? 'correct' : 'wrong');
                }
            }
        });
    }

    window.submitExam = function() {
        let score = 0;
        Object.values(userResponses).forEach(r => {
            if (r.type === 'writing') score += 15; 
            else if (r.isCorrect) score += (r.type === 'choice' ? 2 : 3);
        });
        document.getElementById('final-score').innerText = score;
        document.getElementById('result-modal').style.display = 'flex';
    };

    window.retryWrongMode = function() {
        isRetryMode = true;
        document.getElementById('result-modal').style.display = 'none';
        for (let key in userResponses) {
            if (!userResponses[key].isCorrect && userResponses[key].type !== 'writing') {
                delete userResponses[key];
            }
        }
        alert("å·²è¿›å…¥ã€é”™é¢˜é‡ç»ƒã€‘æ¨¡å¼ï¼Œåšå¯¹çš„é¢˜ç›®å·²è‡ªåŠ¨éšè—ã€‚");
        const activeItem = document.querySelector('.menu-item.active');
        if(activeItem) activeItem.click(); else showSection(0);
    };

</script>
</body>
</html>
